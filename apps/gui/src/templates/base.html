<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}PQC Bench GUI{% endblock %}</title>
  <style>
    * { box-sizing: border-box; }
    :root {
      --island-bg: rgba(128, 128, 128, 0.7);
      --island-radius: 1.5rem;
      --island-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --accent: #ff4d4f; /* professional, readable accent */
      --text: #ffffff;
      --muted: rgba(255,255,255,.85);
    }

    body {
      margin: 0;
      padding: 5vh 5vw;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      line-height: 1.35;
      color: var(--text);
      background-image: url('/static/Images/background.gif');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .island {
      background-color: var(--island-bg);
      border-radius: var(--island-radius);
      box-shadow: var(--island-shadow);
      backdrop-filter: blur(4px);
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem; /* Add padding for spacing inside */
      gap: 1rem; /* ensure inner blocks don’t touch */
    }

    .island:hover {
      transform: translateY(-5px);
    }

    .top-island {
      width: 100%;
      max-width: 1200px;
      min-height: 120px;
      margin: 2vh 0;
    }

    .top-island form { width: 100%; }
    .form-header {
      display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;
      width:100%;
    }
    .controls-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 1rem;
      align-items:end; width:100%;
    }
    .control label { font-size:.9rem; opacity:.95; display:block; text-align:left; margin-bottom:.2rem; }
    .control input[type="number"], .control input[type="text"], .control select {
      padding:0.55rem 0.6rem; border:none; border-radius:0.5rem; width:100%; background:rgba(255,255,255,.96); color:#111;
    }
    .control.inline { display:flex; gap:.5rem; align-items:center; }

    .top-island p {
      margin: 0 0 1rem 0;
      font-size: 1.2rem;
      color: var(--text);
      max-width: 90%;
    }

    .top-island input[type="text"] {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      width: 60%;
      max-width: 400px;
      margin-bottom: 1rem;
      background: rgba(255,255,255,.95);
      color: #111;
    }

    .top-island button {
      padding: 0.6rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      background-color: var(--accent);
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .top-island button:hover {
      background-color: #e04446;
    }
    .form-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: .9rem; align-items:end; }
    .field { grid-column: span 6; text-align:left; }
    .field--full { grid-column: 1 / -1; }
    .hint { font-size:.85rem; opacity:.9; margin-top:.25rem; }
    .checkbox-row { display:flex; gap:.7rem; align-items:center; }
    .actions { display:flex; justify-content:flex-end; gap:.6rem; margin-top:1rem; }
    .actions button { padding:.65rem 1.4rem; border:none; border-radius:.7rem; background: var(--accent); color:#fff; cursor:pointer; box-shadow: 0 2px 6px rgba(0,0,0,.18); }
    .muted-btn { background: rgba(255,255,255,.16); color:#fff; box-shadow: 0 2px 6px rgba(0,0,0,.12); }
    .export-row input[type="text"] { -webkit-appearance:none; -moz-appearance:none; appearance:none; border-radius:1.8rem; padding:0.78rem 1rem; font-size:1rem; min-width:320px; max-width:480px; width:auto; flex:1 1 360px; line-height:1.2; border:1px solid rgba(0,0,0,.15); background: rgba(255,255,255,.98); }
    .field.is-disabled { opacity:.65; }
    .field.is-disabled input { pointer-events:none; }

    .middle-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      max-width: 1200px;
      margin: 2.5vh 0;
      gap: 2rem; /* spacing between boxes */
    }

    .middle-island {
      flex: 1 1 40%;
      min-width: 250px;
      min-height: 350px;
      background-color: var(--island-bg);
      border-radius: var(--island-radius);
      box-shadow: var(--island-shadow);
      backdrop-filter: blur(4px);
      transition: transform 0.3s ease;
      padding: 1rem; /* ensure content spacing */
    }

    .middle-island:hover {
      transform: translateY(-5px);
    }

    .bottom-island {
      width: 100%;
      max-width: 1200px;
      min-height: 120px;
      padding: 2rem;
      margin: 2.5vh 0 1vh 0;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .5rem .35rem; }
    thead th { border-bottom: 1px solid rgba(255,255,255,.25); }
    tbody tr { border-bottom: 1px dashed rgba(255,255,255,.15); }
    tbody tr:nth-child(even) { background: rgba(0,0,0,.08); }

    code, pre, kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    code { background: rgba(255,255,255,.2); padding: .1rem .35rem; border-radius: .3rem; }
    pre { background: rgba(0,0,0,.3); padding: 1rem; border-radius: .5rem; }

    /* Charts: ensure reliable initial paint even under backdrop filters */
    .chart-card {
      background: rgba(0,0,0,.20);
      padding: .75rem;
      border-radius: .5rem;
      min-height: 180px;
      max-height: 220px;
      overflow: hidden;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      position: relative;
      z-index: 1;
      will-change: transform;
    }
    .chart-title { margin: 0 0 .5rem 0; font-weight: 600; }
    .chart-canvas { display:block; width: 100% !important; height: 150px !important; transform: translateZ(0); }

    /* Responsive adjustments */
    @media (max-width: 700px) {
      .middle-row {
        flex-direction: column;
        align-items: center;
      }

      .middle-island {
        width: 100%;
      }

      .top-island input[type="text"] {
        width: 90%;
      }
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(5, 7, 12, 0.72);
      backdrop-filter: blur(6px);
      z-index: 9999;
      color: #fff;
      text-align: center;
      padding: 2rem;
    }
    .loading-overlay.is-visible {
      display: flex;
    }
    .loading-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem 2rem;
      background: rgba(0, 0, 0, 0.35);
      border-radius: 1rem;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 4px solid rgba(255, 255, 255, 0.35);
      border-top-color: var(--accent);
      animation: loading-spin 0.85s linear infinite;
    }
    .loading-text {
      font-size: 1.05rem;
      letter-spacing: 0.04em;
    }
    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading-overlay" class="loading-overlay" hidden>
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <div class="loading-text">Running benchmarks...</div>
    </div>
  </div>

  {% if result_json %}
  <div class="island top-island" style="display:flex; justify-content:space-between; align-items:center;">
    <div style="text-align:left; color:#fff;">
      <h1 style="margin:0 0 .25rem 0; font-size:1.6rem;">Results</h1>
      <div style="opacity:.9;">Benchmark summary and charts</div>
    </div>
    <div>
      <a href="/" style="text-decoration:none;"><button type="button">Back to setup</button></a>
    </div>
  </div>
  <style>
    /* Hide setup and info sections on results view */
    #setup-form { display: none !important; }
    .middle-row { display: none !important; }
  </style>
  {% endif %}
  <!-- Top island -->
  <div class="island top-island" id="setup-form" style="flex-direction:column; align-items:stretch; text-align:left;">
    <div style="text-align:left; color:#fff; margin-bottom:1rem;">
      <h1 style="margin:0 0 .25rem 0; font-size:1.6rem;">PQC Bench</h1>
      <div style="opacity:.9;">Run micro-benchmarks, export results, or compare mechanisms.</div>
    </div>
    {% include '_main_form.html' %}
  </div>
  </div>

  <!-- Middle row with two islands -->
  <div class="middle-row">
    <div class="middle-island" style="padding:1rem; color:#fff; text-align:left;">
      <h3 style="margin-top:0;">Available Algorithms</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:.5rem;">
        {% for name in algos %}
          <div style="background:rgba(0,0,0,.25); padding:.5rem .75rem; border-radius:.5rem; display:flex; justify-content:space-between; align-items:center;">
            <span>{{name}}</span>
            <span style="font-size:.8rem; background:rgba(255,255,255,.2); padding:.1rem .4rem; border-radius:.3rem;">{{ kinds[name] }}</span>
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="middle-island" style="padding:1rem; color:#fff; text-align:left;">
      <h3 style="margin-top:0;">Status</h3>
      {% if error %}
        <div style="color:#ffdddd; background:#902; padding:0.75rem 1rem; border-radius:0.5rem;">Error: {{ error }}</div>
      {% else %}
        <div style="background:rgba(0,0,0,.25); padding:0.75rem 1rem; border-radius:0.5rem;">Ready.</div>
      {% endif %}
      {% if last_export %}
        <div style="margin-top:.75rem;">Exported to: <code>{{ last_export }}</code></div>
      {% endif %}
    </div>
  </div>

  <!-- Bottom island -->
  <div class="island bottom-island" style="color:#fff; text-align:left; gap:1.25rem; flex-direction:column; align-items:stretch; isolation:isolate;">
    <h3 style="margin-top:0;">Result</h3>
    {% if result_json %}
      {% macro fmt_ms(v) -%}
        {{ (v or 0)|round(3) }} ms
      {%- endmacro %}
      {% macro fmt_bytes(v) -%}
        {%- set n = v|int(0) -%}
        {%- if n >= 1024*1024 -%}
          {{ (n/1048576)|round(2) }} MB ({{n}} B)
        {%- elif n >= 1024 -%}
          {{ (n/1024)|round(2) }} KB ({{n}} B)
        {%- else -%}
          {{ n }} B
        {%- endif -%}
      {%- endmacro %}

      <div style="display:flex; gap:1.5rem; flex-wrap:wrap;">
        <div style="flex:1 1 420px; background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem;">
            <div>
              <div style="font-size:1.2rem; font-weight:700;">{{ display_names.get(result_json.algo, result_json.algo) }}</div>
              <div style="opacity:.85;">Algorithm</div>
            </div>
            <div style="font-size:.9rem; background:rgba(255,255,255,.2); padding:.2rem .6rem; border-radius:.4rem;">{{ result_json.kind }}</div>
          </div>
          {% set ns = namespace(has_mem=false) %}
          {% set op_order = ['keygen','encapsulate','decapsulate'] if result_json.kind=='KEM' else ['keygen','sign','verify'] %}
          {% for op in op_order %}
            {% if op in result_json.ops and result_json.ops[op].mem_mean_kb is not none %}
              {% set ns.has_mem = true %}
            {% endif %}
          {% endfor %}

          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,.2);">
                <th style="padding:.4rem .2rem;">Operation</th>
                <th style="padding:.4rem .2rem;">Runs</th>
                <th style="padding:.4rem .2rem;">Mean</th>
                <th style="padding:.4rem .2rem;">Min</th>
                <th style="padding:.4rem .2rem;">Max</th>
                {% if ns.has_mem %}
                  <th style="padding:.4rem .2rem; text-align:right;">Mem mean</th>
                  <th style="padding:.4rem .2rem; text-align:right;">Mem min</th>
                  <th style="padding:.4rem .2rem; text-align:right;">Mem max</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for op in op_order %}
                {% if op in result_json.ops %}
                {% set row = result_json.ops[op] %}
                <tr style="border-bottom:1px dashed rgba(255,255,255,.15);">
                  <td style="padding:.35rem .2rem; text-transform:capitalize;">{{ op }}</td>
                  <td style="padding:.35rem .2rem;">{{ row.runs }}</td>
                  <td style="padding:.35rem .2rem;">{{ fmt_ms(row.mean_ms) }}</td>
                  <td style="padding:.35rem .2rem;">{{ fmt_ms(row.min_ms) }}</td>
                  <td style="padding:.35rem .2rem;">{{ fmt_ms(row.max_ms) }}</td>
                  {% if ns.has_mem %}
                    <td style="padding:.35rem .2rem; text-align:right;">{{ (row.mem_mean_kb or 0)|round(2) }} KB</td>
                    <td style="padding:.35rem .2rem; text-align:right;">{{ (row.mem_min_kb or 0)|round(2) }} KB</td>
                    <td style="padding:.35rem .2rem; text-align:right;">{{ (row.mem_max_kb or 0)|round(2) }} KB</td>
                  {% endif %}
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div style="flex:1 1 320px; background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
          <div style="font-size:1.1rem; font-weight:700; margin-bottom:.75rem;">Metadata</div>
          <table style="width:100%; border-collapse:collapse;">
            <tbody>
              {% for k, v in result_json.meta.items() %}
              <tr style="border-bottom:1px dashed rgba(255,255,255,.15);">
                <td style="padding:.35rem .2rem; opacity:.9;">{{ k.replace('_',' ') }}</td>
                <td style="padding:.35rem .2rem; font-weight:600; text-align:right;">
                  {% if 'len' in k or 'size' in k %}{{ fmt_bytes(v) }}{% else %}{{ v }}{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% if last_export %}
            <div style="margin-top:.75rem; font-size:.9rem;">Saved as: <code>{{ last_export }}</code></div>
          {% endif %}
        </div>
        <div style="flex:1 1 320px; background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
          <div style="font-size:1.1rem; font-weight:700; margin-bottom:.75rem;">Security</div>
          {% set security = result_json.security %}
          {% if not security %}
            <div style="opacity:.85;">Security estimator data unavailable.</div>
          {% else %}
            {% if security.get('error') %}
              <div style="color:#ffdddd; background:rgba(255,0,0,0.25); padding:.6rem .7rem; border-radius:.5rem;">{{ security.error }}</div>
            {% else %}
              {% set metrics = [
                ('Mechanism', 'mechanism'),
                ('Family', 'family'),
                ('Category floor', 'category_floor'),
                ('NIST category', 'nist_category'),
                ('Classical security (bits)', 'classical_bits'),
                ('Quantum security (bits)', 'quantum_bits'),
                ('Shor breakable', 'shor_breakable'),
              ] %}
              <table style="width:100%; border-collapse:collapse;">
                <tbody>
                  {% for label, key in metrics %}
                    {% set value = security.get(key) %}
                    {% if value is not none %}
                    <tr style="border-bottom:1px dashed rgba(255,255,255,.15);">
                      <td style="padding:.35rem .2rem; opacity:.9;">{{ label }}</td>
                      <td style="padding:.35rem .2rem; font-weight:600; text-align:right;">
                        {% if key in ['classical_bits', 'quantum_bits'] and value is number %}
                          {{ value|round(2) }}
                        {% elif key == 'shor_breakable' %}
                          {{ 'Yes' if value else 'No' }}
                        {% else %}
                          {{ value }}
                        {% endif %}
                      </td>
                    </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
              {% if security.notes %}
                <div style="margin-top:.6rem; font-size:.9rem; opacity:.85;">{{ security.notes }}</div>
              {% endif %}
              {% if security.estimator %}
                {% set estimator = security.estimator %}
                <div style="margin-top:.6rem; font-size:.9rem;">
                  <div><strong>Estimator:</strong> {{ estimator.name or 'Unavailable' }}</div>
                  {% if estimator.profile %}
                    <div>Profile: {{ estimator.profile }}</div>
                  {% endif %}
                  <div>Available: {{ 'Yes' if estimator.available else 'No' }}</div>
                </div>
              {% endif %}
              {% set extras = [
                ('Parameters', 'parameters'),
                ('Resources', 'resources'),
                ('Estimates', 'estimates'),
                ('Assumptions', 'assumptions'),
              ] %}
              {% for label, key in extras %}
                {% if security.get(key) %}
                  <details style="margin-top:.6rem;">
                    <summary style="cursor:pointer;">{{ label }}</summary>
                    <pre style="margin-top:.35rem; background:rgba(0,0,0,0.3); padding:.6rem .7rem; border-radius:.5rem; white-space:pre-wrap;">{{ security.get(key) | tojson(indent=2) }}</pre>
                  </details>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
        </div>
      </div>

      <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
          <div style="font-size:1.1rem; font-weight:700;">Run Timings</div>
          <label style="display:flex; align-items:center; gap:.5rem; font-size:.9rem; opacity:.95;">
            <input type="checkbox" id="autoscale-y" checked/>
            Autoscale Y to data range
          </label>
          <label style="display:flex; align-items:center; gap:.5rem; font-size:.9rem; opacity:.95;">
            <input type="checkbox" id="trim-outliers" checked/>
            Trim outliers (5–95%)
          </label>
        </div>
        <div id="charts" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; margin-top:.75rem;"></div>
      </div>

      <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
          <div style="font-size:1.1rem; font-weight:700;">Memory (peak RSS delta, KB)</div>
        </div>
        <div id="mem-charts" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; margin-top:.75rem;"></div>
      </div>

      <details style="margin-top:1rem;">
        <summary style="cursor:pointer;">View raw JSON</summary>
        <pre style="white-space:pre-wrap; word-break:break-word; background:rgba(0,0,0,0.3); padding:1rem; border-radius:0.5rem; max-height:45vh; overflow:auto; margin-top:.5rem;">{{ result_json | tojson(indent=2) }}</pre>
      </details>

      {% if trace_sections %}
      <details style="margin-top:1rem;">
        <summary style="cursor:pointer;">View raw data (one run)</summary>
        <div style="margin-top:.6rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;">
          {% for section in trace_sections %}
          <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.6rem;">
            <div style="font-weight:700; margin-bottom:.5rem;">{{ section.title }}</div>
            {% for item in section['items'] %}
              <div style="margin-bottom:.6rem; text-align:left;">
                <div style="opacity:.9; font-size:.95rem;">{{ item.label }}{% if item.len is not none %} <span style="opacity:.8;">({{ item.len }} B)</span>{% endif %}</div>
                {% if item.text %}
                  <div style="margin-top:.25rem; font-weight:600;">{{ item.text }}</div>
                {% elif item.b64 %}
                  <pre style="white-space:pre-wrap; word-break:break-all; background:rgba(0,0,0,0.3); padding:.6rem .7rem; border-radius:.4rem; max-height:30vh; overflow:auto;">{{ item.b64 }}</pre>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
      </details>
      {% endif %}
    {% else %}
      <p>No run yet. Choose an algorithm and click Run.</p>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function() {
      const kinds = {{ kinds|tojson }};
      const result = {{ (result_json or {})|tojson }};
      const chartsEl = document.getElementById('charts');
      const memChartsEl = document.getElementById('mem-charts');
      const autoScaleY = document.getElementById('autoscale-y');
      const trimCtl = document.getElementById('trim-outliers');
      const charts = [];
      let ro = null;
      function clearCharts() {
        try { charts.forEach(c => c?.destroy?.()); } catch (e) {}
        charts.length = 0;
      }
      function repaintAll() {
        for (const c of charts) {
          try { c.resize(); c.update('none'); } catch (e) {}
        }
      }
      function quantile(arr, q) {
        if (!arr || !arr.length) return 0;
        const a = arr.slice().sort((x,y)=>x-y);
        const idx = (a.length-1)*q;
        const lo = Math.floor(idx), hi = Math.ceil(idx);
        if (lo === hi) return a[lo];
        const h = idx - lo;
        return a[lo] * (1-h) + a[hi] * h;
      }
      function refresh() {
        // Render charts for the current result payload
        if (chartsEl && result && result.ops) {
          chartsEl.innerHTML = '';
          clearCharts();
          const opOrder = (result.kind === 'KEM') ? ['keygen','encapsulate','decapsulate'] : ['keygen','sign','verify'];
          opOrder.forEach((op) => {
            const row = result.ops[op];
            if (!row || !row.series || row.series.length === 0) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-card';
            const title = document.createElement('div');
            title.textContent = op.charAt(0).toUpperCase() + op.slice(1);
            title.className = 'chart-title';
            wrapper.appendChild(title);
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            wrapper.appendChild(canvas);
            chartsEl.appendChild(wrapper);
            // Labels 1..N
            const labels = row.series.map((_, i) => i+1);
            // Build chart (line)
            try {
              const s = row.series.slice();
              let min = Math.min.apply(null, s);
              let max = Math.max.apply(null, s);
              if (trimCtl && trimCtl.checked && s.length >= 5) {
                const q05 = quantile(s, 0.05);
                const q95 = quantile(s, 0.95);
                min = Math.min(min, q05);
                max = Math.max(min + 0.01, q95);
              }
              const pad = Math.max((max - min) * 0.12, 0.2);
              const scaleOptions = autoScaleY && autoScaleY.checked ? {
                beginAtZero: false,
                suggestedMin: min - pad,
                suggestedMax: max + pad,
              } : {
                beginAtZero: true,
              };
              // Defer to next frame to ensure wrapper has a real width
              requestAnimationFrame(() => {
                // Compute concrete pixel size and set intrinsic + CSS sizes
                const rect = wrapper.getBoundingClientRect();
                const pxW = Math.max(260, Math.floor(rect.width) || Math.floor(chartsEl.clientWidth/3) || 320);
                const pxH = 150;
                canvas.width = pxW;
                canvas.height = pxH;
                canvas.style.width = pxW + 'px';
                canvas.style.height = pxH + 'px';

                const chart = new Chart(canvas.getContext('2d'), {
                  type: 'line',
                  data: {
                    labels,
                    datasets: [{
                      label: 'Time (ms)',
                      data: row.series,
                      borderColor: '#ff4d4f',
                      backgroundColor: 'rgba(255,77,79,0.12)',
                      tension: 0.25,
                      pointRadius: 1.5,
                    }]
                  },
                  options: {
                    responsive: false,
                    scales: {
                      x: { title: { display: true, text: 'Run' }, grid: { color: 'rgba(255,255,255,.08)' }, ticks:{ color:'#fff' } },
                      y: Object.assign({ title: { display: true, text: 'ms' }, grid: { color: 'rgba(255,255,255,.08)' }, ticks:{ color:'#fff', callback:(v)=> (typeof v==='number'? v.toFixed(1): v), maxTicksLimit: 5 } }, scaleOptions)
                    },
                    plugins: { legend: { display:false }, decimation: { enabled: true, algorithm: 'min-max' } },
                    animation: false,
                    normalized: true,
                    interaction: { mode: 'nearest', intersect: false }
                  }
                });
                charts.push(chart);
                try { chart.update('none'); } catch (e) {}
                // Fallback: force another update after layout settles
                setTimeout(() => { try { chart.resize(); chart.update('none'); } catch (e) {} }, 150);
                // Hard repaint: toggle a tiny transform to invalidate compositing (fixes Safari/backdrop-filter quirk)
                const old = wrapper.style.transform;
                wrapper.style.transform = 'translateZ(0.0001px)';
                void wrapper.offsetWidth;
                wrapper.style.transform = old || '';
              });
            } catch (e) { /* silently ignore if Chart.js unavailable */ }
          });
          // Memory charts (if any)
          if (memChartsEl) {
            memChartsEl.innerHTML = '';
            opOrder.forEach((op) => {
              const row = result.ops[op];
              if (!row || !row.mem_series_kb || row.mem_series_kb.length === 0) return;
              const wrapper = document.createElement('div');
              wrapper.className = 'chart-card';
              const title = document.createElement('div');
              title.textContent = op.charAt(0).toUpperCase() + op.slice(1);
              title.className = 'chart-title';
              wrapper.appendChild(title);
              const canvas = document.createElement('canvas');
              canvas.className = 'chart-canvas';
              wrapper.appendChild(canvas);
              memChartsEl.appendChild(wrapper);
              const labels = row.mem_series_kb.map((_, i) => i+1);
              try {
                const s = row.mem_series_kb.slice();
                let min = Math.min.apply(null, s);
                let max = Math.max.apply(null, s);
                if (trimCtl && trimCtl.checked && s.length >= 5) {
                  const q05 = quantile(s, 0.05);
                  const q95 = quantile(s, 0.95);
                  min = Math.min(min, q05);
                  max = Math.max(min + 0.01, q95);
                }
                const pad = Math.max((max - min) * 0.12, 0.2);
                const scaleOptions = autoScaleY && autoScaleY.checked ? {
                  beginAtZero: false,
                  suggestedMin: min - pad,
                  suggestedMax: max + pad,
                } : {
                  beginAtZero: true,
                };
                requestAnimationFrame(() => {
                  const rect = wrapper.getBoundingClientRect();
                  const pxW = Math.max(260, Math.floor(rect.width) || Math.floor((memChartsEl.clientWidth||chartsEl.clientWidth)/3) || 320);
                  const pxH = 150;
                  canvas.width = pxW;
                  canvas.height = pxH;
                  canvas.style.width = pxW + 'px';
                  canvas.style.height = pxH + 'px';
                  const chart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [{
                        label: 'KB',
                        data: row.mem_series_kb,
                        borderColor: '#4d9dff',
                        backgroundColor: 'rgba(77,157,255,0.12)',
                        tension: 0.25,
                        pointRadius: 1.5,
                      }]
                    },
                    options: {
                      responsive: false,
                      scales: {
                        x: { title: { display: true, text: 'Run' }, grid: { color: 'rgba(255,255,255,.08)' }, ticks:{ color:'#fff' } },
                        y: Object.assign({ title: { display: true, text: 'KB' }, grid: { color: 'rgba(255,255,255,.08)' }, ticks:{ color:'#fff', callback:(v)=> (typeof v==='number'? v.toFixed(1): v), maxTicksLimit: 5 } }, scaleOptions)
                      },
                      plugins: { legend: { display:false }, decimation: { enabled: true, algorithm: 'min-max' } },
                      animation: false,
                      normalized: true,
                      interaction: { mode: 'nearest', intersect: false }
                    }
                  });
                  charts.push(chart);
                  try { chart.update('none'); } catch (e) {}
                  setTimeout(() => { try { chart.resize(); chart.update('none'); } catch (e) {} }, 150);
                });
              } catch (e) {}
            });
          }
          // After all charts are queued, schedule a further repaint
          requestAnimationFrame(() => setTimeout(repaintAll, 220));
          // Observe size changes and repaint
          try {
            if (!ro && 'ResizeObserver' in window) {
              ro = new ResizeObserver(() => repaintAll());
              ro.observe(chartsEl);
            }
          } catch (e) {}
        }
      }
      if (autoScaleY) autoScaleY.addEventListener('change', refresh);
      if (trimCtl) trimCtl.addEventListener('change', refresh);
      window.addEventListener('load', () => setTimeout(repaintAll, 200));
      refresh();
    })();
  </script>
</body>
</html>
