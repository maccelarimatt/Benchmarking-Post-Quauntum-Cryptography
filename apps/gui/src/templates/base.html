<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}PQC Bench GUI{% endblock %}</title>
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" sizes="any" />
  <link rel="mask-icon" href="/static/favicon.svg" color="#1fb6b8" />
  <link rel="apple-touch-icon" href="/static/Images/pqc-bench-logo.png" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    /* Dark scrollbar styling */
    html {
      scrollbar-width: thin;
      scrollbar-color: rgba(36, 49, 63, 0.85) rgba(7, 11, 17, 0.92);
    }
    html::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    html::-webkit-scrollbar-track {
      background: rgba(7, 11, 17, 0.92);
    }
    html::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.45);
      border-radius: 999px;
      border: 2px solid rgba(7, 11, 17, 0.92);
    }
    html::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.65);
    }

    * { box-sizing: border-box; }
    :root {
      --island-bg: rgba(38, 41, 45, 0.92);
      --island-radius: 1.5rem;
      --island-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --accent: #1fb6b8; /* brand teal accent */
      --text: #ffffff;
      --muted: rgba(255,255,255,.85);
      --btn-radius: .7rem;
    }

    body {
      margin: 0;
      padding: 5vh 5vw;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      line-height: 1.35;
      color: var(--text);
      background:
        radial-gradient(circle at 15% 20%, rgba(31, 182, 184, 0.16), transparent 55%),
        radial-gradient(circle at 80% 15%, rgba(77, 157, 255, 0.12), transparent 60%),
        linear-gradient(180deg, #070b11 0%, #04070c 60%, #020408 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      position: relative;
    }

    .background-animation {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: -1;
    }

    .background-animation span {
      --size: 5px;
      position: absolute;
      top: 50%;
      left: 50%;
      width: var(--size);
      height: var(--size);
      border-radius: 50%;
      background: currentColor;
      opacity: calc(0.25 + (var(--i) % 7) * 0.08);
      color: hsl(calc(190 - var(--i) * 0.45deg), 68%, 58%);
      transform-origin: center;
      transform:
        rotateZ(calc(var(--i) * 2deg))
        translate3d(calc(var(--i) * 0.45px), calc(var(--i) * 0.35px), calc(var(--i) * -0.2px));
      animation: background-orbit calc(12s + var(--i) * 0.08s) ease-in-out infinite alternate;
      mix-blend-mode: screen;
      will-change: transform, color;
    }

    .background-animation span:nth-child(odd) {
      color: hsl(calc(175 + var(--i) * 0.3deg), 64%, 55%);
    }

    @keyframes background-orbit {
      100% {
        color: hsl(calc(188 + var(--i) * 0.35deg), 82%, 68%);
        transform:
          rotateZ(calc(var(--i) * 4deg))
          rotateX(calc(var(--i) * 0.35deg))
          translate3d(calc(var(--i) * -0.65px), calc(var(--i) * 0.5px), calc(var(--i) * -0.35px));
      }
    }

    .island {
      background-color: var(--island-bg);
      border-radius: var(--island-radius);
      box-shadow: var(--island-shadow);
      backdrop-filter: blur(4px);
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 1.25rem; /* slightly tighter to fit content */
      gap: 0.75rem; /* ensure inner blocks donâ€™t touch */
    }

    .island:hover {
      transform: translateY(-5px);
    }

    .top-island {
      width: 100%;
      max-width: 1200px;
      min-height: 80px;
      margin: 2vh 0;
    }

    .top-island form { width: 100%; }
    .form-header {
      display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;
      width:100%;
    }
    .controls-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 1rem;
      align-items:end; width:100%;
    }
    .control label { font-size:.9rem; opacity:.95; display:block; text-align:left; margin-bottom:.2rem; }
    .control input[type="number"], .control input[type="text"] {
      padding:0.55rem 0.6rem; border:none; border-radius:0.5rem; width:100%; background:rgba(255,255,255,.96); color:#111;
    }
    .field select,
    .control select {
      padding:0.55rem 0.6rem;
      border-radius:0.5rem;
      width:100%;
      border:1px solid rgba(148, 163, 184, 0.35);
      background: rgba(21, 26, 35, 0.92);
      color: var(--text);
      color-scheme: dark;
      box-shadow: inset 0 1px 1.5px rgba(0, 0, 0, 0.35);
    }
    .field select:focus,
    .control select:focus {
      outline: none;
      border-color: rgba(31, 182, 184, 0.65);
      box-shadow: 0 0 0 2px rgba(31, 182, 184, 0.25);
    }
    .field select option,
    .control select option {
      background: rgba(10, 14, 20, 0.95);
      color: var(--text);
    }
    .control.inline { display:flex; gap:.5rem; align-items:center; }

    .top-island p {
      margin: 0 0 1rem 0;
      font-size: 1.2rem;
      color: var(--text);
      max-width: 90%;
    }

    .top-island input[type="text"] {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      width: 60%;
      max-width: 400px;
      margin-bottom: 1rem;
      background: rgba(255,255,255,.95);
      color: #111;
    }

    /* Unified button styling (match main page "Run") */
    .btn, button, .actions button, .export-row button, input[type="submit"], input[type="button"], a.btn {
      display: inline-block;
      padding: .65rem 1.4rem;
      border: none;
      border-radius: var(--btn-radius);
      background: var(--accent);
      color: #fff;
      font-size: 1rem;
      line-height: 1.2;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 4px 14px rgba(31,182,184,.25);
      transition: background-color .2s ease, filter .15s ease, box-shadow .2s ease;
    }
    .btn:hover, button:hover, .actions button:hover, input[type="submit"]:hover, input[type="button"]:hover, a.btn:hover {
      filter: brightness(0.92);
      box-shadow: 0 6px 18px rgba(31,182,184,.32);
    }
    .form-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: .9rem; align-items:end; }
    .field { grid-column: span 6; text-align:left; }
    .field--full { grid-column: 1 / -1; }
    .hint { font-size:.85rem; opacity:.9; margin-top:.25rem; }
    .checkbox-row { display:flex; gap:.7rem; align-items:center; }
    .actions { display:flex; justify-content:flex-end; gap:.6rem; margin-top:1rem; }
    .actions button { padding:.65rem 1.4rem; }
    /* Keep muted-btn same look to unify all buttons */
    .muted-btn { background: var(--accent); color:#fff; box-shadow: 0 4px 14px rgba(31,182,184,.25); }
    .export-row input[type="text"] { -webkit-appearance:none; -moz-appearance:none; appearance:none; border-radius:1.8rem; padding:0.78rem 1rem; font-size:1rem; min-width:320px; max-width:480px; width:auto; flex:1 1 360px; line-height:1.2; border:1px solid rgba(0,0,0,.15); background: rgba(255,255,255,.98); }
    .field.is-disabled { opacity:.65; }
    .field.is-disabled input { pointer-events:none; }

    .middle-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      max-width: 1200px;
      margin: 2.5vh 0;
      gap: 2rem; /* spacing between boxes */
    }

    .middle-island {
      flex: 1 1 40%;
      min-width: 250px;
      min-height: 220px;
      background-color: var(--island-bg);
      border-radius: var(--island-radius);
      box-shadow: var(--island-shadow);
      backdrop-filter: blur(4px);
      transition: transform 0.3s ease;
      padding: 1rem; /* ensure content spacing */
    }

    .middle-island:hover {
      transform: translateY(-5px);
    }

    .bottom-island {
      width: 100%;
      max-width: 1200px;
      min-height: 120px;
      padding: 1.5rem;
      margin: 2.5vh 0 1vh 0;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .5rem .35rem; }
    thead th { border-bottom: 1px solid rgba(255,255,255,.25); }
    tbody tr { border-bottom: 1px dashed rgba(255,255,255,.15); }
    tbody tr:nth-child(even) { background: rgba(0,0,0,.08); }

    code, pre, kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    code { background: rgba(255,255,255,.2); padding: .1rem .35rem; border-radius: .3rem; }
    pre { background: rgba(0,0,0,.3); padding: 1rem; border-radius: .5rem; }

    /* Charts: ensure reliable initial paint even under backdrop filters */
    .chart-card {
      background: rgba(0,0,0,.20);
      padding: .75rem;
      border-radius: .5rem;
      min-height: 180px;
      max-height: 220px;
      overflow: hidden;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      position: relative;
      z-index: 1;
      will-change: transform;
    }
    .chart-title { margin: 0 0 .5rem 0; font-weight: 600; }
    .chart-canvas { display:block; width: 100% !important; height: 150px !important; transform: translateZ(0); }

    /* Responsive adjustments */
    @media (max-width: 700px) {
      .middle-row {
        flex-direction: column;
        align-items: center;
      }

      .middle-island {
        width: 100%;
      }

      .top-island input[type="text"] {
        width: 90%;
      }
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      display: flex; /* keep in flow to allow transitions */
      align-items: center;
      justify-content: center;
      background: rgba(5, 7, 12, 0.72);
      backdrop-filter: blur(6px);
      z-index: 9999;
      color: #fff;
      text-align: center;
      padding: 2rem;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 180ms ease;
    }
    .loading-overlay.is-visible { opacity: 1; visibility: visible; pointer-events: auto; }
    .loading-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem 2rem;
      background: rgba(0, 0, 0, 0.35);
      border-radius: 1rem;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      transform: translateY(8px) scale(0.985);
      opacity: 0.0;
      transition: transform 220ms cubic-bezier(.22,.61,.36,1), opacity 180ms ease;
    }
    .loading-overlay.is-visible .loading-card { transform: none; opacity: 1; }
    .progress-wrap { width: 320px; max-width: 70vw; }
    .progress-bar {
      width: 100%; height: 12px; border-radius: 8px; overflow: hidden;
      background: rgba(255,255,255,.18);
      box-shadow: inset 0 2px 6px rgba(0,0,0,.25);
    }
    .progress-bar > .fill {
      height: 100%; width: 0%; background: linear-gradient(90deg, #1fb6b8, #4fd1d9);
      transition: width .18s ease;
    }
    .loading-stage { font-size: 1.05rem; letter-spacing: 0.02em; }
    .loading-detail { opacity: .9; font-size: .95rem; }
  </style>
</head>
<body>
  <div class="background-animation" aria-hidden="true">
    {% for i in range(120) %}
      <span style="--i: {{ i + 1 }};"></span>
    {% endfor %}
  </div>
  <div id="loading-overlay" class="loading-overlay" hidden>
    <div class="loading-card">
      <div id="loading-stage" class="loading-stage">Preparingâ€¦</div>
      <div class="progress-wrap">
        <div class="progress-bar"><div id="loading-progress" class="fill" style="width:0%"></div></div>
      </div>
      <div id="loading-detail" class="loading-detail"></div>
    </div>
  </div>

  {% if result_json %}
  <div class="island top-island" style="display:flex; justify-content:space-between; align-items:center;">
    <div style="text-align:left; color:#fff;">
      <h1 style="margin:0 0 .25rem 0; font-size:1.6rem;">Results</h1>
      <div style="opacity:.9;">Benchmark summary and charts</div>
    </div>
    <div>
      <a href="/" style="text-decoration:none;"><button type="button">Back to setup</button></a>
    </div>
  </div>
  <style>
    /* Hide setup and info sections on results view */
    #setup-form { display: none !important; }
    .middle-row { display: none !important; }
  </style>
  {% endif %}
  <!-- Top island -->
  <div class="island top-island" id="setup-form" style="flex-direction:column; align-items:stretch; text-align:left;">
    <div style="text-align:left; color:#fff; margin-bottom:1rem;">
      <h1 style="margin:0 0 .25rem 0; font-size:1.6rem;">PQC Bench</h1>
      <div style="opacity:.9;">Run micro-benchmarks, export results, or compare mechanisms.</div>
    </div>
    {% include '_main_form.html' %}
  </div>
  </div>

  <!-- Middle row with two islands -->
  <div class="middle-row">
    <div class="middle-island" style="padding:1rem; color:#fff; text-align:left;">
      <h3 style="margin-top:0;">Available Algorithms</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:.5rem;">
        {% for name in algos %}
          <div style="background:rgba(0,0,0,.25); padding:.5rem .75rem; border-radius:.5rem; display:flex; justify-content:space-between; align-items:center;">
            <span>{{name}}</span>
            <span style="font-size:.8rem; background:rgba(255,255,255,.2); padding:.1rem .4rem; border-radius:.3rem;">{{ kinds[name] }}</span>
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="middle-island" style="padding:1rem; color:#fff; text-align:left;">
      <h3 style="margin-top:0;">Status</h3>
      {% if error %}
        <div style="color:#ffdddd; background:#902; padding:0.75rem 1rem; border-radius:0.5rem;">Error: {{ error }}</div>
      {% else %}
        <div style="background:rgba(0,0,0,.25); padding:0.75rem 1rem; border-radius:0.5rem;">Ready.</div>
      {% endif %}
      {% if last_export %}
        <div style="margin-top:.75rem;">Exported to: <code>{{ last_export }}</code></div>
      {% endif %}
    </div>
  </div>

  <!-- Bottom island -->
  <div class="island bottom-island" style="color:#fff; text-align:left; gap:1.25rem; flex-direction:column; align-items:stretch; isolation:isolate;">
    <h3 style="margin-top:0;">Result</h3>
    {% if result_json %}
      {% macro fmt_ms(v) -%}
        {{ (v or 0)|round(3) }} ms
      {%- endmacro %}
      {% macro fmt_bytes(v) -%}
        {%- set n = v|int(0) -%}
        {%- if n >= 1024*1024 -%}
          {{ (n/1048576)|round(2) }} MB ({{n}} B)
        {%- elif n >= 1024 -%}
          {{ (n/1024)|round(2) }} KB ({{n}} B)
        {%- else -%}
          {{ n }} B
        {%- endif -%}
      {%- endmacro %}

      <div style="display:flex; gap:1.5rem; flex-wrap:wrap;">
        <div style="flex:1 1 420px; background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem;">
            <div>
              <div style="font-size:1.2rem; font-weight:700;">{{ display_names.get(result_json.algo, result_json.algo) }}</div>
              <div style="opacity:.85;">Algorithm</div>
              {% if backend_label %}
                <div style="margin-top:.25rem; font-size:.9rem; opacity:.95; background:rgba(0,0,0,.25); display:inline-block; padding:.25rem .5rem; border-radius:.4rem;">
                  {{ backend_label }}
                </div>
              {% endif %}
            </div>
            <div style="font-size:.9rem; background:rgba(255,255,255,.2); padding:.2rem .6rem; border-radius:.4rem;">{{ result_json.kind }}</div>
          </div>
          {% set ns = namespace(has_mem=false) %}
          {% set op_order = ['keygen','encapsulate','decapsulate'] if result_json.kind=='KEM' else ['keygen','sign','verify'] %}
          {% for op in op_order %}
            {% if op in result_json.ops and result_json.ops[op].mem_mean_kb is not none %}
              {% set ns.has_mem = true %}
            {% endif %}
          {% endfor %}

          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid rgba(255,255,255,.2);">
                <th style="padding:.4rem .2rem;">Operation</th>
                <th style="padding:.4rem .2rem;">Runs</th>
                <th style="padding:.4rem .2rem;">Mean</th>
                <th style="padding:.4rem .2rem;">Min</th>
                <th style="padding:.4rem .2rem;">Max</th>
                {% if ns.has_mem %}
                  <th style="padding:.4rem .2rem; text-align:right;">Mem mean</th>
                  <th style="padding:.4rem .2rem; text-align:right;">Mem min</th>
                  <th style="padding:.4rem .2rem; text-align:right;">Mem max</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for op in op_order %}
                {% if op in result_json.ops %}
                {% set row = result_json.ops[op] %}
                <tr style="border-bottom:1px dashed rgba(255,255,255,.15);">
                  <td style="padding:.35rem .2rem; text-transform:capitalize;">{{ op }}</td>
                  <td style="padding:.35rem .2rem;">{{ row.runs }}</td>
                  <td style="padding:.35rem .2rem;">{{ fmt_ms(row.mean_ms) }}</td>
                  <td style="padding:.35rem .2rem;">{{ fmt_ms(row.min_ms) }}</td>
                  <td style="padding:.35rem .2rem;">{{ fmt_ms(row.max_ms) }}</td>
                  {% if ns.has_mem %}
                    <td style="padding:.35rem .2rem; text-align:right;">{{ (row.mem_mean_kb or 0)|round(2) }} KB</td>
                    <td style="padding:.35rem .2rem; text-align:right;">{{ (row.mem_min_kb or 0)|round(2) }} KB</td>
                    <td style="padding:.35rem .2rem; text-align:right;">{{ (row.mem_max_kb or 0)|round(2) }} KB</td>
                  {% endif %}
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
          <!-- Confidence intervals for timings/memory -->
          <div style="margin-top:.75rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:.75rem;">
            <div style="background:rgba(0,0,0,.2); padding:.6rem .7rem; border-radius:.5rem;">
              <div style="font-weight:700; margin-bottom:.45rem;">Timing 95% CI (ms)</div>
              <table style="width:100%;">
                <thead>
                  <tr style="border-bottom:1px solid rgba(255,255,255,.15);"><th style="text-align:left; padding:.25rem 0;">Op</th><th style="text-align:right; padding:.25rem 0;">Low â€“ High</th></tr>
                </thead>
                <tbody>
                  {% for op in op_order %}
                  {% set row = result_json.ops.get(op) %}
                  {% if row %}
                  <tr style="border-bottom:1px dashed rgba(255,255,255,.1);">
                    <td style="padding:.25rem 0; text-transform:capitalize;">{{ op }}</td>
                    <td style="padding:.25rem 0; text-align:right;">{% if row.ci95_low_ms is not none and row.ci95_high_ms is not none %}{{ (row.ci95_low_ms)|round(3) }} â€“ {{ (row.ci95_high_ms)|round(3) }}{% else %}-{% endif %}</td>
                  </tr>
                  {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div style="background:rgba(0,0,0,.2); padding:.6rem .7rem; border-radius:.5rem;">
              <div style="font-weight:700; margin-bottom:.45rem;">Memory 95% CI (KB)</div>
              <table style="width:100%;">
                <thead>
                  <tr style="border-bottom:1px solid rgba(255,255,255,.15);"><th style="text-align:left; padding:.25rem 0;">Op</th><th style="text-align:right; padding:.25rem 0;">Low â€“ High</th></tr>
                </thead>
                <tbody>
                  {% for op in op_order %}
                  {% set row = result_json.ops.get(op) %}
                  {% if row and row.mem_ci95_low_kb is not none and row.mem_ci95_high_kb is not none %}
                  <tr style="border-bottom:1px dashed rgba(255,255,255,.1);">
                    <td style="padding:.25rem 0; text-transform:capitalize;">{{ op }}</td>
                    <td style="padding:.25rem 0; text-align:right;">{{ (row.mem_ci95_low_kb)|round(2) }} â€“ {{ (row.mem_ci95_high_kb)|round(2) }}</td>
                  </tr>
                  {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div style="flex:1 1 320px; background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
          <div style="font-size:1.1rem; font-weight:700; margin-bottom:.75rem;">Metadata</div>
          <table style="width:100%; border-collapse:collapse;">
            <tbody>
              {% set sec_display = result_json.meta.get('security_level_display') if result_json.meta else None %}
              {% if sec_display %}
              <tr style="border-bottom:1px dashed rgba(255,255,255,.15);">
                <td style="padding:.35rem .2rem; opacity:.9;">Security level</td>
                <td style="padding:.35rem .2rem; font-weight:600; text-align:right;">{{ sec_display }}</td>
              </tr>
              {% endif %}
              {% for k, v in result_json.meta.items() if k not in ['security_level', 'security_level_display'] %}
              <tr style="border-bottom:1px dashed rgba(255,255,255,.15);">
                <td style="padding:.35rem .2rem; opacity:.9;">{{ k.replace('_',' ') }}</td>
                <td style="padding:.35rem .2rem; font-weight:600; text-align:right;">
                  {% if 'len' in k or 'size' in k %}{{ fmt_bytes(v) }}{% else %}{{ v }}{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% set env = result_json.meta.get('environment') if result_json.meta else None %}
          {% if env %}
          <details style="margin-top:.6rem;">
            <summary style="cursor:pointer;">Environment</summary>
            <div style="margin-top:.5rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:.6rem;">
              <div style="background:rgba(0,0,0,.2); padding:.6rem .7rem; border-radius:.5rem;">
                <div style="font-weight:600; margin-bottom:.35rem;">Host</div>
                <table style="width:100%"><tbody>
                  <tr><td style="opacity:.9;">CPU</td><td style="text-align:right; font-weight:600;">{{ env.cpu_model or '-' }}</td></tr>
                  <tr><td style="opacity:.9;">OS</td><td style="text-align:right; font-weight:600;">{{ env.os or '-' }}</td></tr>
                  <tr><td style="opacity:.9;">Python</td><td style="text-align:right; font-weight:600;">{{ env.python or '-' }}</td></tr>
                </tbody></table>
              </div>
              <div style="background:rgba(0,0,0,.2); padding:.6rem .7rem; border-radius:.5rem;">
                <div style="font-weight:600; margin-bottom:.35rem;">Dependencies</div>
                {% set deps = env.dependencies if env.dependencies else None %}
                {% if deps %}
                  <table style="width:100%"><tbody>
                  {% for k, v in deps.items() %}
                    {% set v_str = v|string %}
                    <tr>
                      <td style="opacity:.9;">{{ k }}</td>
                      <td style="text-align:right; font-weight:600;" class="kv-mono">
                        <span title="{{ v_str }}">{{ v_str[:12] }}{% if v_str|length > 12 %}â€¦{% endif %}</span>
                        <button type="button" data-copy="{{ v_str }}" style="margin-left:.5rem; padding:.2rem .5rem; font-size:.75rem; border-radius:.35rem; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25); color:#fff;">Copy</button>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody></table>
                {% else %}
                  <div class="kv-sub">No dependency metadata recorded.</div>
                {% endif %}
              </div>
              <div style="background:rgba(0,0,0,.2); padding:.6rem .7rem; border-radius:.5rem;">
                <div style="font-weight:600; margin-bottom:.35rem;">Build Flags</div>
                {% set bf = env.build_flags if env.build_flags else None %}
                {% if bf %}
                  {% for k, flags in bf.items() %}
                    {% set block_id = 'bf_single_' ~ loop.index0 ~ '_' ~ k %}
                    <details style="margin:.35rem 0;">
                      <summary style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                        <span>{{ k }} <span class="kv-sub">({{ flags|length }} entries)</span></span>
                        <button type="button" data-copy-target="{{ block_id }}" style="padding:.25rem .6rem; font-size:.78rem; border-radius:.35rem; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25); color:#fff;">Copy JSON</button>
                      </summary>
                      <pre id="{{ block_id }}" style="white-space:pre-wrap; margin:.4rem 0 0 0; max-height:220px; overflow:auto;">{{ flags | tojson(indent=2) }}</pre>
                    </details>
                  {% endfor %}
                {% else %}
                  <div class="kv-sub">No build flags recorded.</div>
                {% endif %}
              </div>
            </div>
          </details>
          {% endif %}
          {% if last_export %}
            <div style="margin-top:.75rem; font-size:.9rem;">Saved as: <code>{{ last_export }}</code></div>
          {% endif %}
        </div>
        <div style="flex:1 1 320px; background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
          <div style="font-size:1.1rem; font-weight:700; margin-bottom:.75rem;">Security</div>
          {% set security = result_json.security %}
          {% if not security %}
            <div style="opacity:.85;">Security estimator data unavailable.</div>
          {% else %}
            {% if security.get('error') %}
              <div style="color:#ffdddd; background:rgba(255,0,0,0.25); padding:.6rem .7rem; border-radius:.5rem;">{{ security.error }}</div>
            {% else %}
              {% set metrics = [
                ('Mechanism', 'mechanism'),
                ('Family', 'family'),
                ('Category floor', 'category_floor'),
                ('NIST category', 'nist_category'),
                ('Classical security (bits)', 'classical_bits'),
                ('Quantum security (bits)', 'quantum_bits'),
                ('Shor breakable', 'shor_breakable'),
              ] %}
              <table style="width:100%; border-collapse:collapse;">
                <tbody>
                  {% for label, key in metrics %}
                    {% set value = security.get(key) %}
                    {% if value is not none %}
                    <tr style="border-bottom:1px dashed rgba(255,255,255,.15);">
                      <td style="padding:.35rem .2rem; opacity:.9;">{{ label }}</td>
                      <td style="padding:.35rem .2rem; font-weight:600; text-align:right;">
                        {% if key in ['classical_bits', 'quantum_bits'] and value is number %}
                          {{ value|round(2) }}
                        {% elif key == 'shor_breakable' %}
                          {{ 'Yes' if value else 'No' }}
                        {% else %}
                          {{ value }}
                        {% endif %}
                      </td>
                    </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
              {% if security.notes %}
                <div style="margin-top:.6rem; font-size:.9rem; opacity:.85;">{{ security.notes }}</div>
              {% endif %}
              {% if security.estimator %}
                {% set estimator = security.estimator %}
                <div style="margin-top:.6rem; font-size:.9rem;">
                  <div><strong>Estimator:</strong> {{ estimator.name or 'Unavailable' }}</div>
                  {% if estimator.profile %}
                    <div>Profile: {{ estimator.profile }}</div>
                  {% endif %}
                  <div>Available: {{ 'Yes' if estimator.available else 'No' }}</div>
                </div>
              {% endif %}
              {% set bf = security.bruteforce if security.bruteforce else None %}
              {% if bf %}
                <div style="margin-top:.75rem;">
                  <div style="font-weight:700; margin-bottom:.35rem;">Brute-Force Baseline</div>
                  <table style="width:100%; border-collapse:collapse;">
                    <tbody>
                      <tr style="border-bottom:1px dashed rgba(255,255,255,.15);"><td style="padding:.35rem .2rem; opacity:.9;">Model</td><td style="padding:.35rem .2rem; font-weight:600; text-align:right;">{{ bf.model }}</td></tr>
                      <tr style="border-bottom:1px dashed rgba(255,255,255,.15);"><td style="padding:.35rem .2rem; opacity:.9;">Search space</td><td style="padding:.35rem .2rem; font-weight:600; text-align:right;">2^{{ '%.0f'|format(bf.space_bits) if bf.space_bits is number else bf.space_bits }}</td></tr>
                      <tr style="border-bottom:1px dashed rgba(255,255,255,.15);"><td style="padding:.35rem .2rem; opacity:.9;">Rate unit</td><td style="padding:.35rem .2rem; font-weight:600; text-align:right;">{{ bf.rate_unit }}</td></tr>
                    </tbody>
                  </table>
                  <div style="margin-top:.35rem;"><span class="kv-sub">Time to succeed (years)</span></div>
                  <table class="vlines" style="margin-top:.25rem;">
                    <thead>
                      <tr><th style="text-align:left;">Rate</th><th>Years</th><th>log10</th></tr>
                    </thead>
                    <tbody>
                      {% for rate in bf.rates %}
                        {% set key = (rate|string) %}
                        {% set row = bf.time_years[key] if bf.time_years and key in bf.time_years else None %}
                        <tr>
                          <td style="text-align:left;">{% if bf.rate_unit == 'cores' %}{{ rate|int }} cores{% else %}{{ '%.0e'|format(rate) }} t/s{% endif %}</td>
                          <td>{% if row and row.sci %}{{ row.sci }}{% else %}-{% endif %}</td>
                          <td>{% if row and row.log10 is not none %}{{ '%.2f'|format(row.log10) }}{% else %}-{% endif %}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  {% if bf.assumptions and bf.assumptions.rationale %}
                    <div class="kv-sub" style="margin-top:.35rem;">{{ bf.assumptions.rationale }}</div>
                  {% endif %}
                </div>
              {% endif %}
              {% set extras = [
                ('Parameters', 'parameters'),
                ('Resources', 'resources'),
                ('Estimates', 'estimates'),
                ('Assumptions', 'assumptions'),
              ] %}
              {% for label, key in extras %}
                {% if security.get(key) %}
                  <details style="margin-top:.6rem;">
                    <summary style="cursor:pointer;">{{ label }}</summary>
                    <pre style="margin-top:.35rem; background:rgba(0,0,0,0.3); padding:.6rem .7rem; border-radius:.5rem; white-space:pre-wrap;">{{ security.get(key) | tojson(indent=2) }}</pre>
                  </details>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
        </div>
      </div>

      <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
          <div style="font-size:1.1rem; font-weight:700;">Run Timings</div>
          <label style="display:flex; align-items:center; gap:.5rem; font-size:.9rem; opacity:.95;">
            <input type="checkbox" id="autoscale-y" checked/>
            Autoscale Y to data range
          </label>
          <label style="display:flex; align-items:center; gap:.5rem; font-size:.9rem; opacity:.95;">
            <input type="checkbox" id="trim-outliers" checked/>
            Trim outliers (5â€“95%)
          </label>
        </div>
        <div id="charts" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; margin-top:.75rem;"></div>
      </div>

      <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
          <div style="font-size:1.1rem; font-weight:700;">Memory (peak RSS delta, KB)</div>
        </div>
        <div id="mem-charts" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; margin-top:.75rem;"></div>
      </div>

      <!-- Projected runtimes (runtime scaling) -->
      <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem; margin-top:.75rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
          <div style="font-size:1.1rem; font-weight:700;">Projected Runtimes (by device)</div>
        </div>
        <div id="runtime-charts" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; margin-top:.75rem;"></div>
      </div>

      {% if last_export %}
      <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.75rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
          <div style="font-size:1.1rem; font-weight:700;">Raw Exports</div>
        </div>
        <div style="margin-top:.5rem;">
          <a href="/{{ last_export }}" target="_blank" style="color:#aee; text-decoration:underline;">Open JSON summary export</a>
        </div>
      </div>
      {% endif %}

      {# Inline JSON viewer removed; use export link above instead #}

      {% if trace_sections %}
      <details style="margin-top:1rem;">
        <summary style="cursor:pointer;">View raw data (one run)</summary>
        <div style="margin-top:.6rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;">
          {% for section in trace_sections %}
          <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.6rem;">
            <div style="font-weight:700; margin-bottom:.5rem;">{{ section.title }}</div>
            {% for item in section['items'] %}
              <div style="margin-bottom:.6rem; text-align:left;">
                <div style="opacity:.9; font-size:.95rem;">{{ item.label }}{% if item.len is not none %} <span style="opacity:.8;">({{ item.len }} B)</span>{% endif %}</div>
                {% if item.text %}
                  <div style="margin-top:.25rem; font-weight:600;">{{ item.text }}</div>
                {% elif item.b64 %}
                  <pre style="white-space:pre-wrap; word-break:break-all; background:rgba(0,0,0,0.3); padding:.6rem .7rem; border-radius:.4rem; max-height:30vh; overflow:auto;">{{ item.b64 }}</pre>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
      </details>
      {% endif %}
    {% else %}
      <p>No run yet. Choose an algorithm and click Run.</p>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Global legend style: use circular markers instead of rectangles
    try {
      if (window.Chart && Chart.defaults && Chart.defaults.plugins && Chart.defaults.plugins.legend) {
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.boxWidth = 10;
        Chart.defaults.plugins.legend.labels.boxHeight = 10;
      }
    } catch (e) {}
  </script>
  <script>
    (function() {
      const kinds = {{ kinds|tojson }};
      const result = {{ (result_json or {})|tojson }};
      const chartsEl = document.getElementById('charts');
      const memChartsEl = document.getElementById('mem-charts');
      const runtimeHost = document.getElementById('runtime-charts');
      const autoScaleY = document.getElementById('autoscale-y');
      const trimCtl = document.getElementById('trim-outliers');
      const charts = [];
      let ro = null;
      function clearCharts() {
        try { charts.forEach(c => c?.destroy?.()); } catch (e) {}
        charts.length = 0;
      }
      function repaintAll() {
        for (const c of charts) {
          try { c.resize(); c.update('none'); } catch (e) {}
        }
      }
      function quantile(arr, q) {
        if (!arr || !arr.length) return 0;
        const a = arr.slice().sort((x,y)=>x-y);
        const idx = (a.length-1)*q;
        const lo = Math.floor(idx), hi = Math.ceil(idx);
        if (lo === hi) return a[lo];
        const h = idx - lo;
        return a[lo] * (1-h) + a[hi] * h;
      }
      function refresh() {
        // Render charts for the current result payload
        if (chartsEl && result && result.ops) {
          chartsEl.innerHTML = '';
          clearCharts();
          const opOrder = (result.kind === 'KEM') ? ['keygen','encapsulate','decapsulate'] : ['keygen','sign','verify'];
          opOrder.forEach((op) => {
            const row = result.ops[op];
            if (!row || !row.series || row.series.length === 0) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-card';
            const title = document.createElement('div');
            title.textContent = op.charAt(0).toUpperCase() + op.slice(1);
            title.className = 'chart-title';
            wrapper.appendChild(title);
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            wrapper.appendChild(canvas);
            chartsEl.appendChild(wrapper);
            // Labels 1..N
            const labels = row.series.map((_, i) => i+1);
            // Build chart (line)
            try {
              const s = row.series.slice();
              let min = Math.min.apply(null, s);
              let max = Math.max.apply(null, s);
              if (trimCtl && trimCtl.checked && s.length >= 5) {
                const q05 = quantile(s, 0.05);
                const q95 = quantile(s, 0.95);
                min = Math.min(min, q05);
                max = Math.max(min + 0.01, q95);
              }
              const pad = Math.max((max - min) * 0.12, 0.2);
              const scaleOptions = autoScaleY && autoScaleY.checked ? {
                beginAtZero: false,
                suggestedMin: min - pad,
                suggestedMax: max + pad,
              } : {
                beginAtZero: true,
              };
              // Defer to next frame to ensure wrapper has a real width
              requestAnimationFrame(() => {
                // Compute concrete pixel size and set intrinsic + CSS sizes
                const rect = wrapper.getBoundingClientRect();
                const pxW = Math.max(260, Math.floor(rect.width) || Math.floor(chartsEl.clientWidth/3) || 320);
                const pxH = 150;
                canvas.width = pxW;
                canvas.height = pxH;
                canvas.style.width = pxW + 'px';
                canvas.style.height = pxH + 'px';

                const chart = new Chart(canvas.getContext('2d'), {
                  type: 'line',
                  data: {
                    labels,
                    datasets: [{
                      label: 'Time (ms)',
                      data: row.series,
                      borderColor: '#1fb6b8',
                      backgroundColor: 'rgba(31,182,184,0.15)',
                      tension: 0.25,
                      pointRadius: 1.5,
                    }]
                  },
                  options: {
                    responsive: false,
                    scales: {
                      x: { title: { display: true, text: 'Run' }, grid: { color: 'rgba(255,255,255,.08)' }, ticks:{ color:'#fff' } },
                      y: Object.assign({ title: { display: true, text: 'ms' }, grid: { color: 'rgba(255,255,255,.08)' }, ticks:{ color:'#fff', callback:(v)=> (typeof v==='number'? v.toFixed(1): v), maxTicksLimit: 5 } }, scaleOptions)
                    },
                    plugins: { legend: { display:true, position:'bottom', labels:{ color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10 } }, decimation: { enabled: true, algorithm: 'min-max' } },
                    animation: false,
                    normalized: true,
                    interaction: { mode: 'nearest', intersect: false }
                  }
                });
                charts.push(chart);
                try { chart.update('none'); } catch (e) {}
                // Fallback: force another update after layout settles
                setTimeout(() => { try { chart.resize(); chart.update('none'); } catch (e) {} }, 150);
                // Hard repaint: toggle a tiny transform to invalidate compositing (fixes Safari/backdrop-filter quirk)
                const old = wrapper.style.transform;
                wrapper.style.transform = 'translateZ(0.0001px)';
                void wrapper.offsetWidth;
                wrapper.style.transform = old || '';
              });
            } catch (e) { /* silently ignore if Chart.js unavailable */ }
          });
          // Memory charts (if any)
          if (memChartsEl) {
            memChartsEl.innerHTML = '';
            opOrder.forEach((op) => {
              const row = result.ops[op];
              if (!row || !row.mem_series_kb || row.mem_series_kb.length === 0) return;
              const wrapper = document.createElement('div');
              wrapper.className = 'chart-card';
              const title = document.createElement('div');
              title.textContent = op.charAt(0).toUpperCase() + op.slice(1);
              title.className = 'chart-title';
              wrapper.appendChild(title);
              const canvas = document.createElement('canvas');
              canvas.className = 'chart-canvas';
              wrapper.appendChild(canvas);
              memChartsEl.appendChild(wrapper);
              const labels = row.mem_series_kb.map((_, i) => i+1);
              try {
                const s = row.mem_series_kb.slice();
                let min = Math.min.apply(null, s);
                let max = Math.max.apply(null, s);
                if (trimCtl && trimCtl.checked && s.length >= 5) {
                  const q05 = quantile(s, 0.05);
                  const q95 = quantile(s, 0.95);
                  min = Math.min(min, q05);
                  max = Math.max(min + 0.01, q95);
                }
                const pad = Math.max((max - min) * 0.12, 0.2);
                const scaleOptions = autoScaleY && autoScaleY.checked ? {
                  beginAtZero: false,
                  suggestedMin: min - pad,
                  suggestedMax: max + pad,
                } : {
                  beginAtZero: true,
                };
                requestAnimationFrame(() => {
                  const rect = wrapper.getBoundingClientRect();
                  const pxW = Math.max(260, Math.floor(rect.width) || Math.floor((memChartsEl.clientWidth||chartsEl.clientWidth)/3) || 320);
                  const pxH = 150;
                  canvas.width = pxW;
                  canvas.height = pxH;
                  canvas.style.width = pxW + 'px';
                  canvas.style.height = pxH + 'px';
                  const chart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [{
                        label: 'KB',
                        data: row.mem_series_kb,
                        borderColor: '#4d9dff',
                        backgroundColor: 'rgba(77,157,255,0.12)',
                        tension: 0.25,
                        pointRadius: 1.5,
                      }]
                    },
                    options: {
                      responsive: false,
                      scales: {
                        x: { title: { display: true, text: 'Run' }, grid: { color: 'rgba(255,255,255,.08)' }, ticks:{ color:'#fff' } },
                        y: Object.assign({ title: { display: true, text: 'KB' }, grid: { color: 'rgba(255,255,255,.08)' }, ticks:{ color:'#fff', callback:(v)=> (typeof v==='number'? v.toFixed(1): v), maxTicksLimit: 5 } }, scaleOptions)
                      },
                      plugins: { legend: { display:true, position:'bottom', labels:{ color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10 } }, decimation: { enabled: true, algorithm: 'min-max' } },
                      animation: false,
                      normalized: true,
                      interaction: { mode: 'nearest', intersect: false }
                    }
                  });
                  charts.push(chart);
                  try { chart.update('none'); } catch (e) {}
                  setTimeout(() => { try { chart.resize(); chart.update('none'); } catch (e) {} }, 150);
                });
              } catch (e) {}
            });
          }
          // Runtime scaling charts (if any)
          if (runtimeHost && result && result.ops) {
            runtimeHost.innerHTML = '';
            const opOrder = (result.kind === 'KEM') ? ['keygen','encapsulate','decapsulate'] : ['keygen','sign','verify'];
            // Collect devices
            const deviceSet = new Set();
            for (const op of opOrder) {
              const row = result.ops[op];
              const rs = row && row.runtime_scaling;
              if (rs && rs.predictions) Object.keys(rs.predictions).forEach(k => deviceSet.add(k));
            }
            const devices = Array.from(deviceSet).sort();
            if (devices.length) {
              const palette = ['#1fb6b8','#ffd166','#4d9dff'];
              function addDeviceChart(device) {
                const wrap = document.createElement('div');
                wrap.className = 'chart-card';
                const title = document.createElement('div');
                title.textContent = `Device: ${device}`; title.className = 'chart-title';
                wrap.appendChild(title);
                const canvas = document.createElement('canvas');
                canvas.className = 'chart-canvas';
                wrap.appendChild(canvas);
                runtimeHost.appendChild(wrap);
                const labels = opOrder.map(op => op.charAt(0).toUpperCase()+op.slice(1));
                const values = opOrder.map(op => {
                  const row = result.ops[op];
                  const rs = row && row.runtime_scaling;
                  const pred = rs && rs.predictions && rs.predictions[device];
                  return pred && typeof pred.predicted_ms === 'number' ? pred.predicted_ms : null;
                });
                requestAnimationFrame(() => {
                  const rect = wrap.getBoundingClientRect();
                  const pxW = Math.max(260, Math.floor(rect.width) || Math.floor(runtimeHost.clientWidth/2) || 320);
                  const pxH = 150;
                  canvas.width = pxW; canvas.height = pxH; canvas.style.width = pxW+'px'; canvas.style.height = pxH+'px';
                  const chart = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'ms', data: values, backgroundColor: palette[0] }] },
                    options: {
                      responsive: false,
                      scales: {
                        x: { grid:{ color:'rgba(255,255,255,.08)' }, ticks:{ color:'#fff' } },
                        y: { beginAtZero:true, title:{ display:true, text:'ms' }, grid:{ color:'rgba(255,255,255,.08)' }, ticks:{ color:'#fff' } },
                      },
                      plugins: { legend: { display:false } },
                      animation: false,
                      normalized: true,
                    }
                  });
                  charts.push(chart);
                });
              }
              devices.forEach(addDeviceChart);
            } else {
              const msg = document.createElement('div');
              msg.className = 'kv-sub';
              msg.textContent = 'Runtime scaling unavailable (no device predictions).';
              runtimeHost.appendChild(msg);
            }
          }
          // After all charts are queued, schedule a further repaint
          requestAnimationFrame(() => setTimeout(repaintAll, 220));
          // Observe size changes and repaint
          try {
            if (!ro && 'ResizeObserver' in window) {
              ro = new ResizeObserver(() => repaintAll());
              ro.observe(chartsEl);
            }
          } catch (e) {}
        }
      }
      if (autoScaleY) autoScaleY.addEventListener('change', refresh);
      if (trimCtl) trimCtl.addEventListener('change', refresh);
      window.addEventListener('load', () => setTimeout(repaintAll, 200));
      refresh();
    })();
  </script>
  <script>
    // Copy helpers for environment panel
    (function(){
      function copyText(txt){ try { navigator.clipboard.writeText(txt); } catch(e) {} }
      function copyFromEl(id){ var el=document.getElementById(id); if(!el) return; var t=el.innerText||el.textContent||''; copyText(t); }
      document.addEventListener('click', function(ev){
        var el = ev.target; if (!el || !el.getAttribute) return;
        var v = el.getAttribute('data-copy'); if (v!=null) copyText(v);
        var id = el.getAttribute('data-copy-target'); if (id) copyFromEl(id);
      }, false);
    })();
  </script>
</body>
</html>
