<!DOCTYPE html>
<html lang="en">
<head>
  {% from '_header.html' import header_styles %}
  {% from '_background_effects.html' import background_layer, background_rules %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PQC Bench - Compare Results</title>
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" sizes="any" />
  <link rel="mask-icon" href="/static/favicon.svg" color="#1fb6b8" />
  <link rel="apple-touch-icon" href="/static/Images/pqc-bench-logo.png" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    /* Dark scrollbar styling */
    html {
      scrollbar-width: thin;
      scrollbar-color: rgba(36, 49, 63, 0.85) rgba(7, 11, 17, 0.92);
    }
    html::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    html::-webkit-scrollbar-track {
      background: rgba(7, 11, 17, 0.92);
    }
    html::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.45);
      border-radius: 999px;
      border: 2px solid rgba(7, 11, 17, 0.92);
    }
    html::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.65);
    }

    * { box-sizing: border-box; }

    :root {
      --island-bg: rgba(25, 30, 38, 0.92);
      --island-radius: 1.6rem;
      --island-shadow: 0 28px 60px rgba(9, 12, 18, 0.55);
      --accent: #1fb6b8;
      --accent-soft: rgba(31, 182, 184, 0.18);
      --accent-glow: rgba(31, 182, 184, 0.47);
      --accent-strong: rgba(14, 165, 233, 0.85);
      --text: #f8fafc;
      --muted: rgba(226, 232, 240, 0.78);
      --divider: rgba(148, 163, 184, 0.12);
      --card-bg: rgba(14, 20, 29, 0.88);
      --card-border: rgba(255, 255, 255, 0.08);
      --success: #34d399;
      --warn: #f59e0b;
      --danger: #ef4444;
    }

    body {
      margin: 0;
      padding: 0 5vw 6vh;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(circle at 15% 20%, rgba(31, 182, 184, 0.16), transparent 55%),
        radial-gradient(circle at 80% 15%, rgba(77, 157, 255, 0.12), transparent 60%),
        linear-gradient(180deg, #070b11 0%, #04070c 60%, #020408 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 420px;
      height: 420px;
      border-radius: 50%;
      filter: blur(120px);
      opacity: 0.6;
      pointer-events: none;
      z-index: 0;
      mix-blend-mode: screen;
    }

    body::before {
      background: linear-gradient(145deg, rgba(31, 182, 184, 0.35), rgba(56, 189, 248, 0.25));
      top: 5vh;
      left: 10vw;
      animation: floatOrb 22s ease-in-out infinite;
    }

    body::after {
      background: linear-gradient(145deg, rgba(196, 181, 253, 0.32), rgba(148, 163, 184, 0.2));
      bottom: 12vh;
      right: 12vw;
      animation: floatOrb 26s ease-in-out infinite reverse;
    }

    @keyframes floatOrb {
      0%, 100% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.58; }
      50% { transform: translate3d(30px, -35px, 0) scale(1.08); opacity: 0.72; }
    }

    @keyframes badgeFloat {
      0%, 100% { transform: translate3d(0, 0, 0); }
      50% { transform: translate3d(0, -8px, 0); }
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(200%); }
    }

    main.results-shell {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 2.25rem;
      position: relative;
      z-index: 2;
    }

    main.results-shell > * {
      width: 100%;
    }

    .island {
      background: var(--island-bg);
      border-radius: var(--island-radius);
      box-shadow: var(--island-shadow);
      padding: 2.2rem;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .island::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.04);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; }

    /* Refined details layout */
    /* Layout: fewer cards per row for better readability */
    .details-grid { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) {
      .details-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 1500px) {
      .details-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .details-card { background: rgba(0,0,0,.28); border-radius:.7rem; padding:1rem; border:1px solid rgba(255,255,255,.10); box-shadow: 0 6px 18px rgba(0,0,0,.22); }
    .details-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
    .details-title { font-weight:700; letter-spacing:.2px; }
    .badges { display:flex; gap:.4rem; flex-wrap:wrap; }
    .badge { font-size:.72rem; padding:.12rem .5rem; border-radius:.4rem; border:1px solid rgba(255,255,255,.22); background: rgba(255,255,255,.08); text-transform:uppercase; letter-spacing:.3px; }
    table.kv { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    table.kv col.kv-label { width:48%; }
    table.kv col.kv-value { width:52%; }
    table.kv td { padding:.42rem .45rem; border-bottom:1px dashed rgba(255,255,255,.12); vertical-align:top; }
    table.kv tr:last-child td { border-bottom:none; }
    .kv-label { color: rgba(255,255,255,.85); font-size:.9rem; }
    .kv-value { color:#fff; font-weight:600; font-size:.95rem; }
    .kv-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kv-sub { font-size:.85rem; font-weight:500; opacity:.9; }
    /* Two-column rows for stats tables */
    .row-grid-2 { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) { .row-grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .row-grid-2 + .row-grid-2 { margin-top: 1.25rem; }
    /* Unified stats grid for all six tables */
    .stats-grid { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) { .stats-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .card {
      margin: 0;
      background: rgba(9, 14, 22, 0.62);
      border-radius: 1.15rem;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 22px 44px rgba(4, 7, 14, 0.38);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg, rgba(31, 182, 184, 0.2), rgba(56, 189, 248, 0.08));
      opacity: 0.38;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .card > * { position: relative; z-index: 1; }
    /* Avoid inner cards touching the outer island outline */
    .card--full {
      width: 100%;
      margin: 0;
      padding: 1.8rem 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      border-radius: 1rem;
      overflow: hidden;
      background: rgba(9, 14, 22, 0.4);
    }
    thead th {
      text-align: left;
      font-size: 0.78rem;
      letter-spacing: 0.24px;
      text-transform: uppercase;
      padding: 0.68rem 0.75rem;
      background: rgba(15, 23, 32, 0.88);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      color: rgba(248, 250, 252, 0.85);
    }
    tbody tr:nth-child(even) { background: rgba(15, 22, 33, 0.35); }
    th, td {
      padding: 0.68rem 0.75rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.16);
      color: rgba(241, 245, 249, 0.92);
    }
    tr:last-child td { border-bottom: none; }
    table.vlines th:not(:last-child),
    table.vlines td:not(:last-child) { border-right: 1px solid rgba(148, 163, 184, 0.16); }
    table.vlines thead th { border-bottom: 1px solid rgba(255, 255, 255, 0.18); }
    summary {
      list-style: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      font-weight: 600;
      letter-spacing: 0.28px;
      color: rgba(248, 250, 252, 0.9);
      position: relative;
      padding: 0.3rem 0;
      transition: color 0.2s ease;
    }
    summary:hover { color: #fff; }
    summary::marker,
    details > summary::marker { display: none; }
    summary::-webkit-details-marker,
    details > summary::-webkit-details-marker { display: none; }
    summary::after {
      content: '>';
      font-size: 0.8rem;
      opacity: 0.7;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }
    details[open] > summary::after {
      transform: rotate(90deg);
      opacity: 1;
    }
    .details-grid { display:grid; grid-template-columns: 1fr; gap:1.6rem; }
    @media (min-width: 900px) { .details-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1500px) { .details-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    .details-card {
      background: rgba(8, 14, 22, 0.74);
      border-radius: 1.2rem;
      border: 1px solid rgba(255, 255, 255, 0.09);
      padding: 1.6rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
      box-shadow: 0 28px 52px rgba(3, 8, 18, 0.4);
      position: relative;
      overflow: hidden;
      transition: transform 0.28s ease, box-shadow 0.28s ease, border-color 0.28s ease;
    }
    .details-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle at top right, rgba(31, 182, 184, 0.42), transparent 65%);
      opacity: 0.45;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .details-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 32px 60px rgba(3, 10, 20, 0.45);
      border-color: rgba(31, 182, 184, 0.28);
    }
    .details-card > * { position: relative; z-index: 1; }
    .details-header { display:flex; align-items:center; justify-content:space-between; gap:0.75rem; margin-bottom:1rem; }
    .details-title { font-size:1.08rem; font-weight:700; letter-spacing:0.24px; }
    .badges { display:flex; gap:0.5rem; flex-wrap:wrap; }
    .badge {
      font-size:0.72rem;
      padding:0.2rem 0.65rem;
      border-radius:999px;
      border:1px solid rgba(148, 229, 255, 0.35);
      background: linear-gradient(135deg, rgba(31, 182, 184, 0.26), rgba(148, 163, 184, 0.18));
      text-transform:uppercase;
      letter-spacing:0.32px;
      color: rgba(248, 250, 252, 0.9);
      box-shadow: 0 12px 26px rgba(2, 10, 18, 0.35);
      animation: badgeFloat 7s ease-in-out infinite;
    }
    .badge:nth-child(even) { animation-delay: 1.4s; }
    table.kv {
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
      background: transparent;
      margin-top:0.45rem;
    }
    table.kv col.kv-label { width:48%; }
    table.kv col.kv-value { width:52%; }
    table.kv td {
      padding:0.48rem 0.5rem;
      border-bottom:1px dashed rgba(148, 163, 184, 0.2);
      vertical-align:top;
    }
    table.kv tr:last-child td { border-bottom:none; }
    .kv-label { color: rgba(226, 232, 240, 0.88); font-size:0.88rem; }
    .kv-value { color:#fff; font-weight:600; font-size:0.96rem; }
    .island--hero {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1.5rem;
      padding:2.6rem 2.8rem;
      background: linear-gradient(135deg, rgba(31, 182, 184, 0.16), rgba(56, 189, 248, 0.08));
    }
    .island--hero::before {
      content:"";
      position:absolute;
      inset:-12% -32% 48% 38%;
      background: radial-gradient(circle at top left, rgba(31, 182, 184, 0.48), transparent 70%);
      opacity:0.6;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .hero-title {
      font-size:1.75rem;
      font-weight:800;
      letter-spacing:0.35px;
      margin:0 0 0.45rem 0;
    }
    .hero-subline {
      opacity:0.85;
      font-size:1rem;
      color: var(--muted);
    }
    .hero-subline strong { color: var(--text); font-weight:600; }
    .hero-category {
      margin-top:0.4rem;
      font-size:0.95rem;
      color: var(--muted);
    }
    .hero-category span { color: var(--text); font-weight:600; }
    .hero-actions { display:flex; align-items:center; justify-content:flex-end; }
    .island--alert {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.18), rgba(15, 19, 25, 0.82));
      border: 1px solid rgba(239, 68, 68, 0.42);
      box-shadow: 0 24px 46px rgba(127, 29, 29, 0.35);
    }
    .export-grid {
      margin-top:0.6rem;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:1rem;
    }
    .export-link-card {
      background: rgba(9, 14, 22, 0.58);
      padding:1.05rem;
      border-radius:0.85rem;
      border:1px solid rgba(255,255,255,0.08);
      text-align:left;
      box-shadow:0 18px 36px rgba(4, 9, 18, 0.32);
      transition: transform 0.22s ease, border-color 0.22s ease, box-shadow 0.22s ease;
    }
    .export-link-card:hover {
      transform: translateY(-4px);
      border-color: rgba(31, 182, 184, 0.28);
      box-shadow:0 24px 48px rgba(4, 9, 18, 0.4);
    }
    .export-link-card a {
      color: rgba(166, 238, 255, 0.92);
      text-decoration:underline;
      font-weight:600;
    }
    .export-link-card a:hover { color:#fff; }
    .hamming-card {
      overflow-x: auto;
    }
    .hamming-card .hamming-table {
      width: 100%;
      table-layout: fixed;
      font-size: 0.82rem;
    }
    .hamming-card .hamming-table th,
    .hamming-card .hamming-table td {
      padding: 0.48rem 0.35rem;
      white-space: nowrap;
    }
    .hamming-card .hamming-table th:first-child,
    .hamming-card .hamming-table td:first-child {
      width: 24%;
    }
    .hamming-card .hamming-table th:nth-child(2),
    .hamming-card .hamming-table td:nth-child(2) {
      width: 16%;
    }
    .hamming-card .hamming-table th:not(:first-child):not(:nth-child(2)),
    .hamming-card .hamming-table td:not(:first-child):not(:nth-child(2)) {
      width: calc((100% - 40%) / 5);
    }
    @media (max-width: 900px) {
      .hamming-card .hamming-table th,
      .hamming-card .hamming-table td { font-size: 0.78rem; padding: 0.42rem 0.3rem; }
    }
    @keyframes metricBestPulse {
      0%, 100% { box-shadow: 0 0 0 rgba(34, 197, 94, 0); }
      50% { box-shadow: 0 0 18px rgba(34, 197, 94, 0.45); }
    }
    @keyframes metricWorstPulse {
      0%, 100% { box-shadow: 0 0 0 rgba(239, 68, 68, 0); }
      50% { box-shadow: 0 0 18px rgba(239, 68, 68, 0.42); }
    }
    .metric-best,
    .metric-worst {
      position: relative;
      overflow: hidden;
      font-weight: 600;
      letter-spacing: 0.18px;
      border-width: 1px;
    }
    .metric-best {
      background: radial-gradient(circle at 25% 25%, rgba(34, 197, 94, 0.35), transparent 70%) rgba(8, 20, 16, 0.85);
      color: #d1fae5;
      border-color: rgba(34, 197, 94, 0.55);
      animation: metricBestPulse 3.6s ease-in-out infinite;
      outline: 1px solid rgba(34, 197, 94, 0.6);
      outline-offset: -2px;
      text-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
    }
    .metric-worst {
      background: radial-gradient(circle at 25% 25%, rgba(239, 68, 68, 0.32), transparent 70%) rgba(28, 8, 12, 0.85);
      color: #fee2e2;
      border-color: rgba(239, 68, 68, 0.52);
      animation: metricWorstPulse 3.6s ease-in-out infinite;
      outline: 1px solid rgba(239, 68, 68, 0.55);
      outline-offset: -2px;
      text-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
    }
    .metric-best::before,
    .metric-worst::before {
      content: "";
      position: absolute;
      inset: -140% -30%;
      background: conic-gradient(from 0deg, transparent 0deg, rgba(255,255,255,0.4) 120deg, transparent 240deg);
      opacity: 0.45;
      animation: shimmer 4.8s linear infinite;
      pointer-events: none;
      z-index: -1;
      mix-blend-mode: screen;
    }
    .metric-best::after { box-shadow: inset 0 0 22px rgba(34, 197, 94, 0.25); }
    .metric-worst::after { box-shadow: inset 0 0 22px rgba(239, 68, 68, 0.22); }
    }
    @media (max-width: 720px) {
      .island--hero {
        flex-direction:column;
        align-items:flex-start;
        padding:2.2rem 1.9rem;
      }
      .hero-title { font-size:1.5rem; }
    }
    /* Unified button styling (match main page "Run") */
    .btn, button, input[type="submit"], input[type="button"], a.btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.7rem 1.65rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: linear-gradient(135deg, rgba(31, 182, 184, 0.92), rgba(56, 189, 248, 0.68));
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.24px;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 16px 32px rgba(31, 182, 184, 0.36);
      transition: transform 0.18s ease, box-shadow 0.22s ease, filter 0.18s ease;
    }
    .btn:hover, button:hover, input[type="submit"]:hover, input[type="button"]:hover, a.btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 22px 42px rgba(31, 182, 184, 0.42);
    }
    .btn:active, button:active, input[type="submit"]:active, input[type="button"]:active, a.btn:active {
      transform: translateY(0);
      filter: brightness(0.95);
    }
    {{ header_styles() | safe }}
    /* Header strip (reuse from home) */
    .security-model-card { display:flex; flex-direction:column; gap:1.1rem; }
    .security-model-header { display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:.75rem; }
    .security-model-title { font-size:1.15rem; font-weight:700; letter-spacing:.24px; }
    .security-model-subtitle { font-size:.88rem; opacity:.85; max-width:620px; }
    .security-chart { margin:0; padding:1rem 1.2rem; background:rgba(0,0,0,.22); border-radius:.85rem; border:1px solid rgba(31,182,184,.25); }
    .security-chart canvas { max-height:260px !important; }
    .security-chart figcaption { margin-top:.6rem; font-size:.82rem; opacity:.85; }
    .security-detail-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:.85rem; }
    .security-detail-card { background:rgba(15,18,24,.68); border-radius:.85rem; border:1px solid rgba(255,255,255,.12); padding:1rem 1.1rem; display:flex; flex-direction:column; gap:.8rem; box-shadow:0 10px 28px rgba(0,0,0,.24); }
    .security-detail-header { display:flex; flex-direction:column; gap:.35rem; }
    .security-detail-name { font-size:1.05rem; font-weight:700; letter-spacing:.18px; }
    .security-detail-summary { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:.35rem .9rem; }
    .meta-pair { display:flex; flex-direction:column; gap:.15rem; }
    .meta-label { font-size:.72rem; text-transform:uppercase; letter-spacing:.24px; opacity:.75; }
    .meta-value { font-size:.9rem; font-weight:600; }
    .meta-note { font-size:.78rem; opacity:.72; }
    .metrics-list { list-style:none; margin:0; padding:0; display:grid; gap:.45rem; }
    .metrics-list li { display:flex; justify-content:space-between; align-items:flex-start; gap:.75rem; background:rgba(255,255,255,.05); border-radius:.55rem; padding:.45rem .6rem; }
    .metric-label { font-size:.82rem; opacity:.86; }
    .metric-value { font-size:.88rem; font-weight:600; text-align:right; word-break:break-word; }
    .metrics-empty { font-size:.82rem; opacity:.7; background:rgba(255,255,255,.05); border-radius:.55rem; padding:.5rem .65rem; }
    .security-notes-card { display:flex; flex-direction:column; gap:.85rem; }
    .security-notes-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:.7rem; }
    .security-notes-item { position:relative; padding:.8rem 1.1rem .85rem 1.9rem; background:rgba(15,18,24,.72); border:1px solid rgba(255,255,255,.12); border-radius:.9rem; box-shadow:0 10px 28px rgba(0,0,0,.24); display:flex; flex-wrap:wrap; gap:.45rem .85rem; align-items:flex-start; }
    .security-notes-item::before { content:'•'; position:absolute; left:.8rem; top:1.05rem; color:var(--accent); font-size:1.18rem; line-height:1; }
    .note-name { font-size:1rem; font-weight:700; letter-spacing:.2px; }
    .note-chipbox { display:flex; flex-wrap:wrap; gap:.35rem; }
    .note-chip { font-size:.68rem; letter-spacing:.25px; text-transform:uppercase; padding:.15rem .55rem; border-radius:.4rem; border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.08); color:rgba(255,255,255,.88); }
    .note-estimator { display:block; font-size:.9rem; font-style:italic; opacity:.9; color:rgba(255,255,255,.88); }
    .note-points { list-style:none; margin:.35rem 0 0 0; padding:0; width:100%; display:flex; flex-direction:column; gap:.35rem; }
    .note-point { position:relative; padding-left:1.1rem; font-size:.9rem; color:rgba(255,255,255,.9); line-height:1.45; }
    .note-point::before { content:'•'; position:absolute; left:0; top:0; color:rgba(255,255,255,.7); font-size:1rem; line-height:1.45; }
    .notes-empty { font-size:.85rem; opacity:.8; background:rgba(255,255,255,.04); border-radius:.6rem; padding:.7rem .85rem; }
    {{ background_rules() | safe }}
  </style>
</head>
<body>
  {{ background_layer() }}
  {% from '_header.html' import render_header %}
  {{ render_header(title='Post-Quantum Cryptography Benchmarking', subtitle='Run and Compare Different Cryptographic Algorithms', active='benchmarking') }}
  <main class="results-shell">
    <div class="island island--hero">
      <div>
        <div class="hero-title">Compare Results - {{ compare.kind }}</div>
        <div class="hero-subline">Runs: {{ compare.runs }}{% if compare.kind=='SIG' %}, Message size: {{ compare.message_size }} B{% endif %} | Mode: {{ (compare.mode or 'cold')|capitalize }}</div>
        {% if compare.security_category is not none %}
          {% set cat_hint = {1:'~ AES-128', 3:'~ AES-192', 5:'~ AES-256'} %}
          <div class="hero-category">Requested NIST Category {{ compare.security_category }} <span>{{ cat_hint.get(compare.security_category, '') }}</span></div>
        {% endif %}
      </div>
      <div class="hero-actions">
        <a href="/" class="btn">Back to setup</a>
      </div>
    </div>

  <style>
    /* Hide legacy LLM block/modal */
    #llm-modal { display:none !important; }
    .llm-fab {
      position: fixed;
      right: 22px;
      bottom: 22px;
      z-index: 1100;
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      background: linear-gradient(135deg, rgba(31, 182, 184, 0.92), rgba(56, 189, 248, 0.68));
      color: #fff;
      padding: 0.65rem 1.25rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 999px;
      box-shadow: 0 22px 42px rgba(2, 8, 14, 0.6);
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.24px;
      transition: transform 0.18s ease, box-shadow 0.22s ease, filter 0.18s ease;
    }
    .llm-fab:hover { transform: translateY(-2px); filter: brightness(1.05); box-shadow: 0 30px 56px rgba(2, 8, 14, 0.65); }
    .llm-panel {
      position: fixed;
      right: 22px;
      bottom: 84px;
      width: min(90vw, 420px);
      height: min(75vh, 520px);
      z-index: 1100;
      display:none;
      background: rgba(6, 11, 18, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 1.1rem;
      box-shadow: 0 32px 60px rgba(2, 5, 12, 0.6);
      backdrop-filter: blur(18px);
      overflow: hidden;
    }
    .llm-panel::before {
      content: "";
      position: absolute;
      inset: -40% 10% auto -20%;
      width: 120%;
      height: 140%;
      background: radial-gradient(circle at center, rgba(31, 182, 184, 0.35), transparent 70%);
      opacity: 0.55;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .llm-panel.open { display:flex; flex-direction: column; }
    .llm-head { display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; border-bottom:1px solid rgba(255,255,255,0.14); position:relative; z-index:1; }
    .llm-title { font-weight:700; letter-spacing:0.25px; }
    .llm-hint { font-size:0.85rem; opacity:0.85; color: var(--muted); }
    .llm-body { flex: 1; overflow: auto; padding:1rem 1.1rem; line-height:1.5; background: rgba(5, 10, 18, 0.55); position:relative; z-index:1; }
    .llm-input { display:flex; gap:0.5rem; padding:0.7rem 0.9rem; border-top:1px solid rgba(255,255,255,0.14); background: rgba(5, 10, 18, 0.68); position:relative; z-index:1; }
    .llm-input textarea { flex:1; resize:none; min-height:42px; max-height:110px; padding:0.6rem 0.7rem; border-radius:0.65rem; border:1px solid rgba(255,255,255,0.18); background: rgba(9, 16, 26, 0.9); color:#fff; box-shadow: inset 0 1px 0 rgba(255,255,255,0.08); }
    .llm-btn { padding:0.6rem 1.05rem; border:none; border-radius:0.65rem; background: linear-gradient(135deg, rgba(31, 182, 184, 0.88), rgba(56, 189, 248, 0.58)); color:#fff; font-weight:600; cursor:pointer; box-shadow: 0 14px 28px rgba(2, 8, 14, 0.45); transition: filter 0.18s ease, transform 0.18s ease; }
    .llm-btn:hover { filter: brightness(1.05); transform: translateY(-1px); }
  </style>
  <div id="llm-widget">
    <button id="llm-fab" class="llm-fab">AI Summary Report</button>
    <div id="llm-panel" class="llm-panel" role="dialog" aria-label="AI analysis">
      <div class="llm-head">
        <div class="llm-title">AI-Assisted Analysis</div>
        <div style="display:flex; gap:.5rem; align-items:center;">
          <div class="llm-hint" id="llm-provider-hint">Provider: auto</div>
          <button id="llm-download" class="llm-btn" title="Download PDF" style="display:none;" disabled>Download PDF</button>
        </div>
      </div>
      <div id="llm-chat-output" class="llm-body">Ask for a summary or request a focus area.</div>
      <div class="llm-input">
        <textarea id="llm-chat-input" placeholder="e.g., Focus on verify latency outliers and memory spikes..."></textarea>
        <button id="llm-send" class="llm-btn">Send</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="/static/js/llm-charts.js"></script>
  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const fab = document.getElementById('llm-fab');
      const panel = document.getElementById('llm-panel');
      const out = document.getElementById('llm-chat-output');
      const input = document.getElementById('llm-chat-input');
      const send = document.getElementById('llm-send');
      const hint = document.getElementById('llm-provider-hint');
      const downloadBtn = document.getElementById('llm-download');
      const sanitizeOptions = window.DOMPurify ? { ADD_ATTR: ['data-chart'] } : undefined;
      if (downloadBtn) { downloadBtn.style.display = 'none'; downloadBtn.disabled = true; }

      function togglePanel(force) {
        const open = panel.classList.contains('open');
        const next = (typeof force === 'boolean') ? force : !open;
        if (next) panel.classList.add('open'); else panel.classList.remove('open');
      }
      fab.addEventListener('click', () => togglePanel());
      async function downloadPdf() {
        try {
          const source = document.getElementById('llm-chat-output');
          if (!source) return;
          const html = source.innerHTML || '';
          if (!html.trim()) return;
          const doc = `<!DOCTYPE html><html><head><meta charset="utf-8"/><title>PQC LLM Analysis</title>
          <style>
    body { background:#fff; color:#000; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; line-height:1.5; padding:16px; }
            h1,h2,h3 { margin-top:1.1em; }
            table { width:100%; border-collapse:collapse; }
            th,td { border:1px solid #ccc; padding:.4rem .5rem; }
            ul { margin: .5rem 0 .75rem 1.25rem; }
          </style></head><body>${html}</body></html>`;
          const opts = {
            margin: 10,
            filename: 'pqc-llm-analysis.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, background: '#ffffff', scrollX: 0, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };
          if (window.html2pdf) {
            await window.html2pdf().from(doc).set(opts).save();
          } else {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
            s.onload = () => window.html2pdf().from(doc).set(opts).save();
            document.head.appendChild(s);
          }
        } catch (e) { console.error(e); }
      }
      if (downloadBtn) downloadBtn.addEventListener('click', downloadPdf);

      async function runAnalysis() {
        try {
          send.disabled = true; input.disabled = true;
          if (downloadBtn) { downloadBtn.disabled = true; downloadBtn.style.display = 'none'; }
          const req = (input && input.value && input.value.trim()) ? input.value.trim() : undefined;
          out.textContent = 'Generating analysis...';
          const res = await fetch('/api/analysis', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compare: compareData, request: req })
          });
          const data = await res.json();
          if (!data || data.ok === false) throw new Error((data && data.error) || 'Analysis failed');
          if (hint) {
            const provider = (data.provider || 'auto');
            const model = (data.model || '');
            const usedFallback = !!data.used_fallback;
            hint.textContent = 'Provider: ' + provider + (model ? (' · ' + model) : '') + (usedFallback ? ' (fallback)' : '');
          }
          const html = String(data.analysis || '').trim();
          const sanitized = window.DOMPurify ? DOMPurify.sanitize(html, sanitizeOptions) : html;
          out.innerHTML = sanitized;
          if (window.renderLLMCharts && html) { window.renderLLMCharts(out); }
          if (downloadBtn) {
            if (html) {
              downloadBtn.style.display = 'inline-block';
              downloadBtn.disabled = false;
            } else {
              downloadBtn.style.display = 'none';
              downloadBtn.disabled = true;
            }
          }
        } catch (e) {
          out.textContent = String(e);
          if (downloadBtn) { downloadBtn.disabled = true; downloadBtn.style.display = 'none'; }
        } finally {
          send.disabled = false; input.disabled = false;
        }
      }
      function sendHandler(){ if (!panel.classList.contains('open')) togglePanel(true); runAnalysis(); }
      send.addEventListener('click', sendHandler);
      input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' && (ev.ctrlKey || ev.metaKey)) { ev.preventDefault(); sendHandler(); } });
    })();
  </script>


  {% if errors and errors|length %}
  <div class="island island--alert">
    <div style="font-weight:700; margin-bottom:.5rem;">Some algorithms were skipped:</div>
    <ul>
    {% for name, msg in errors.items() %}
      <li><b>{{ name }}</b>: {{ msg }}</li>
    {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- Algorithm Details -->
  <!-- Previously hidden by inline style. Make visible again. -->
  <div class="island" id="llm-block">
    <div style="font-weight:700; margin-bottom:.75rem;">Algorithm Details</div>
    <div class="details-grid">
      {% for a in compare.algos %}
      <div class="details-card">
        <div class="details-header">
          <div class="details-title">{{ a.label }}</div>
          <div class="badges">
            {% set algo_lower = a.name|lower %}
            {% set is_classical = 'rsa' in algo_lower %}
            <span class="badge">{{ 'Classical' if is_classical else 'PQC' }}</span>
            <span class="badge">{{ compare.kind }}</span>
          </div>
        </div>
        {% set backend = a.meta.backend if a.meta and a.meta.backend else '' %}
        {% if backend == 'liboqs' %}
          {% set backend_hint = 'liboqs (C via python-oqs)' %}
        {% elif backend == 'rsa' %}
          {% set backend_hint = 'cryptography/OpenSSL (classical)' %}
        {% elif backend == 'native' %}
          {% set backend_hint = 'native C backend (pqcbench_native)' %}
        {% else %}
          {% set backend_hint = 'unknown backend' %}
        {% endif %}
        <table class="kv">
          <colgroup>
            <col class="kv-label" />
            <col class="kv-value" />
          </colgroup>
          <tbody>
            {% set sec_obj = a.security or {} %}
            {% set sec_params = sec_obj.get('parameters', {}) %}
            {% set canonical_sizes = sec_params.get('sizes_bytes') %}
            <tr>
              <td class="kv-label">Version</td>
              <td class="kv-value">
                {% set version = '-' %}
                {% set m = a.meta %}
                {% if m %}
                  {% if 'mechanism' in m and m['mechanism'] %}{% set version = m['mechanism'] %}
                  {% elif 'algorithm' in m and m['algorithm'] %}{% set version = m['algorithm'] %}
                  {% elif 'alg' in m and m['alg'] %}{% set version = m['alg'] %}
                  {% elif 'mech' in m and m['mech'] %}{% set version = m['mech'] %}
                  {% elif 'version' in m and m['version'] %}{% set version = m['version'] %}
                  {% endif %}
                {% endif %}
                {{ version }}
              </td>
            </tr>
            {% set sec_meta = a.meta.get('security_level') if a.meta else None %}
            {% set sec_display = a.meta.get('security_level_display') if a.meta else None %}
            {% if sec_display or sec_meta %}
            <tr>
              <td class="kv-label">Security level</td>
              <td class="kv-value">
                {% if sec_display %}{{ sec_display }}{% else %}Category {{ sec_meta.applied_category or '-' }}{% endif %}
              </td>
            </tr>
            {% endif %}
            {% set std = sec_obj.get('standardization') %}
            {% if std %}
            <tr>
              <td class="kv-label">Standardization</td>
              <td class="kv-value">
                <span class="badge">{% if std.label %}{{ std.label }}{% else %}{{ std.state }}{% endif %}</span>
                {% if std.state %}<span class="kv-sub" style="margin-left:.4rem;">{{ std.state }}</span>{% endif %}
              </td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Backend</td>
              <td class="kv-value">{{ backend_hint }}</td>
            </tr>
            <tr>
              <td class="kv-label">Public key length</td>
              <td class="kv-value kv-mono">
                {% if a.meta.public_key_len is not none %}
                  {{ a.meta.public_key_len }} B ({{ a.meta.public_key_len * 8 }} bits)
                {% else %}-{% endif %}
              </td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('public_key') %}
            <tr>
              <td class="kv-label">Spec public key length</td>
              <td class="kv-value kv-mono">{{ canonical_sizes.get('public_key') }} B</td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Secret key length</td>
              <td class="kv-value kv-mono">
                {% if a.meta.secret_key_len is not none %}
                  {{ a.meta.secret_key_len }} B ({{ a.meta.secret_key_len * 8 }} bits)
                {% else %}-{% endif %}
              </td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('secret_key') %}
            <tr>
              <td class="kv-label">Spec secret key length</td>
              <td class="kv-value kv-mono">{{ canonical_sizes.get('secret_key') }} B</td>
            </tr>
            {% endif %}
            {% if compare.kind == 'KEM' %}
            <tr>
              <td class="kv-label">Ciphertext length</td>
              <td class="kv-value kv-mono">{% if a.meta.ciphertext_len is not none %}{{ a.meta.ciphertext_len }} B{% else %}-{% endif %}</td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('ciphertext') %}
            <tr>
              <td class="kv-label">Spec ciphertext length</td>
              <td class="kv-value kv-mono">{{ canonical_sizes.get('ciphertext') }} B</td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Shared secret length</td>
              <td class="kv-value kv-mono">{% if a.meta.shared_secret_len is not none %}{{ a.meta.shared_secret_len }} B{% else %}-{% endif %}</td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('shared_secret') %}
            <tr>
              <td class="kv-label">Spec shared secret length</td>
              <td class="kv-value kv-mono">{{ canonical_sizes.get('shared_secret') }} B</td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">CT expansion ratio (ct / shared secret)</td>
              <td class="kv-value">{% if a.meta.ciphertext_expansion_ratio is not none %}{{ '%.3f'|format(a.meta.ciphertext_expansion_ratio) }}{% else %}-{% endif %}</td>
            </tr>
            {% else %}
            <tr>
              <td class="kv-label">Signature length</td>
              <td class="kv-value kv-mono">{% if a.meta.signature_len is not none %}{{ a.meta.signature_len }} B{% else %}-{% endif %}</td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('signature') %}
            <tr>
              <td class="kv-label">Spec signature length</td>
              <td class="kv-value kv-mono">
                {{ canonical_sizes.get('signature') }} B
                {% if canonical_sizes.get('signature_min') %}
                  <div class="kv-sub">Min {{ canonical_sizes.get('signature_min') }} B</div>
                {% endif %}
                {% if canonical_sizes.get('signature_note') %}
                  <div class="kv-sub">{{ canonical_sizes.get('signature_note') }}</div>
                {% endif %}
              </td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Message size</td>
              <td class="kv-value kv-mono">{% if a.meta.message_size is not none %}{{ a.meta.message_size }} B{% else %}-{% endif %}</td>
            </tr>
            <tr>
              <td class="kv-label">Sig expansion ratio (sig / message)</td>
              <td class="kv-value">{% if a.meta.signature_expansion_ratio is not none %}{{ '%.3f'|format(a.meta.signature_expansion_ratio) }}{% else %}-{% endif %}</td>
            </tr>
            {% endif %}
            {% if a.meta.secret_key_analysis %}
            <tr>
              <td class="kv-label">Key analysis</td>
              <td class="kv-value">
                {% set ana = a.meta.secret_key_analysis %}
                {% if ana %}
                  {% set model = 'model' in ana and ana['model'] or None %}
                  {% set hw = 'hw' in ana and ana['hw'] or None %}
                  <div class="kv-sub">
                    {% if model %}
                      {% if model.name is defined %}<span>{{ model.name }}</span>{% else %}<span>{{ model }}</span>{% endif %}
                    {% endif %}
                    {% if 'bits_per_sample' in ana %}<span> · bits/sample: {{ ana['bits_per_sample'] }}</span>{% endif %}
                    {% if hw %}
                      <span> · HW mean: {% if hw['mean_fraction'] is not none %}{{ '%.4f'|format(hw['mean_fraction']) }}{% else %}-{% endif %}</span>
                      {% if hw and hw['expected_fraction'] is not none %}<span> (expected {{ '%.3f'|format(hw['expected_fraction']) }})</span>{% endif %}
                    {% endif %}
                  </div>
                {% else %}-{% endif %}
              </td>
            </tr>
            {% endif %}
            {% set val = a.meta.validation if a.meta and a.meta.validation else None %}
            {% if val %}
            <tr>
              <td class="kv-label">Validation</td>
              <td class="kv-value">
                {% set status = val.status or '-' %}
                {% set cases = val.cases if val.cases is not none else '-' %}
                {% set passes = val.passes if val.passes is not none else '-' %}
                {% set fails = val.fails if val.fails is not none else '-' %}
                <span class="kv-sub">{{ status }}</span> — cases: {{ cases }}, passes: {{ passes }}, fails: {{ fails }}
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing (ms)</div>
        <div id="timing-charts" class="grid"></div>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory (KB)</div>
        <div id="memory-charts" class="grid"></div>
      </div>
    </div>
  </div>

  

  <!-- Explicit Timing and Memory tables -->
  <div class="island">
    <div class="stats-grid">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Comparison Table (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} mean (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          {% set extrema = namespace(bests=[], worsts=[]) %}
          {% for op in ops %}
            {% set values = [] %}
            {% for a in compare.algos %}
              {% if a.ops.get(op) and a.ops[op].mean_ms is not none %}
                {% set values = values + [a.ops[op].mean_ms] %}
              {% endif %}
            {% endfor %}
            {% if values %}
              {% set extrema.bests = extrema.bests + [values|min] %}
              {% set extrema.worsts = extrema.worsts + [values|max] %}
            {% else %}
              {% set extrema.bests = extrema.bests + [None] %}
              {% set extrema.worsts = extrema.worsts + [None] %}
            {% endif %}
          {% endfor %}
          {% set bests = extrema.bests %}
          {% set worsts = extrema.worsts %}
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set idx = loop.index0 %}
                {% set op_data = a.ops.get(op) %}
                {% if op_data and op_data.mean_ms is not none %}
                  {% set val = op_data.mean_ms %}
                  {% set key = '%.6f'|format(val) %}
                  {% set classes = [] %}
                  {% if bests[idx] is not none and key == '%.6f'|format(bests[idx]) %}
                    {% set classes = classes + ['metric-best'] %}
                  {% endif %}
                  {% if worsts[idx] is not none and key == '%.6f'|format(worsts[idx]) %}
                    {% set classes = classes + ['metric-worst'] %}
                  {% endif %}
                  {% set class_attr = classes|join(' ') %}
                  <td{% if class_attr %} class="{{ class_attr }}"{% endif %}>{{ '%.3f'|format(val) }}</td>
                {% else %}
                  <td>-</td>
                {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Comparison Table (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} mem mean (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          {% set mem_extrema = namespace(bests=[], worsts=[]) %}
          {% for op in ops %}
            {% set values = [] %}
            {% for a in compare.algos %}
              {% if a.ops.get(op) and a.ops[op].mem_mean_kb is not none %}
                {% set values = values + [a.ops[op].mem_mean_kb] %}
              {% endif %}
            {% endfor %}
            {% if values %}
              {% set mem_extrema.bests = mem_extrema.bests + [values|min] %}
              {% set mem_extrema.worsts = mem_extrema.worsts + [values|max] %}
            {% else %}
              {% set mem_extrema.bests = mem_extrema.bests + [None] %}
              {% set mem_extrema.worsts = mem_extrema.worsts + [None] %}
            {% endif %}
          {% endfor %}
          {% set mem_bests = mem_extrema.bests %}
          {% set mem_worsts = mem_extrema.worsts %}
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set idx = loop.index0 %}
                {% set op_data = a.ops.get(op) %}
                {% if op_data and op_data.mem_mean_kb is not none %}
                  {% set val = op_data.mem_mean_kb %}
                  {% set key = '%.6f'|format(val) %}
                  {% set classes = [] %}
                  {% if mem_bests[idx] is not none and key == '%.6f'|format(mem_bests[idx]) %}
                    {% set classes = classes + ['metric-best'] %}
                  {% endif %}
                  {% if mem_worsts[idx] is not none and key == '%.6f'|format(mem_worsts[idx]) %}
                    {% set classes = classes + ['metric-worst'] %}
                  {% endif %}
                  {% set class_attr = classes|join(' ') %}
                  <td{% if class_attr %} class="{{ class_attr }}"{% endif %}>{{ '%.2f'|format(val) }}</td>
                {% else %}
                  <td>-</td>
                {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Standard Deviation (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} stddev (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          {% set std_extrema = namespace(bests=[], worsts=[]) %}
          {% for op in ops %}
            {% set values = [] %}
            {% for a in compare.algos %}
              {% if a.ops.get(op) and a.ops[op].stddev_ms is not none %}
                {% set values = values + [a.ops[op].stddev_ms] %}
              {% endif %}
            {% endfor %}
            {% if values %}
              {% set std_extrema.bests = std_extrema.bests + [values|min] %}
              {% set std_extrema.worsts = std_extrema.worsts + [values|max] %}
            {% else %}
              {% set std_extrema.bests = std_extrema.bests + [None] %}
              {% set std_extrema.worsts = std_extrema.worsts + [None] %}
            {% endif %}
          {% endfor %}
          {% set std_bests = std_extrema.bests %}
          {% set std_worsts = std_extrema.worsts %}
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set idx = loop.index0 %}
                {% set op_data = a.ops.get(op) %}
                {% if op_data and op_data.stddev_ms is not none %}
                  {% set val = op_data.stddev_ms %}
                  {% set key = '%.6f'|format(val) %}
                  {% set classes = [] %}
                  {% if std_bests[idx] is not none and key == '%.6f'|format(std_bests[idx]) %}
                    {% set classes = classes + ['metric-best'] %}
                  {% endif %}
                  {% if std_worsts[idx] is not none and key == '%.6f'|format(std_worsts[idx]) %}
                    {% set classes = classes + ['metric-worst'] %}
                  {% endif %}
                  {% set class_attr = classes|join(' ') %}
                  <td{% if class_attr %} class="{{ class_attr }}"{% endif %}>{{ '%.3f'|format(val) }}</td>
                {% else %}
                  <td>-</td>
                {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Standard Deviation (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} stddev (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          {% set mem_std_extrema = namespace(bests=[], worsts=[]) %}
          {% for op in ops %}
            {% set values = [] %}
            {% for a in compare.algos %}
              {% if a.ops.get(op) and a.ops[op].mem_stddev_kb is not none %}
                {% set values = values + [a.ops[op].mem_stddev_kb] %}
              {% endif %}
            {% endfor %}
            {% if values %}
              {% set mem_std_extrema.bests = mem_std_extrema.bests + [values|min] %}
              {% set mem_std_extrema.worsts = mem_std_extrema.worsts + [values|max] %}
            {% else %}
              {% set mem_std_extrema.bests = mem_std_extrema.bests + [None] %}
              {% set mem_std_extrema.worsts = mem_std_extrema.worsts + [None] %}
            {% endif %}
          {% endfor %}
          {% set mem_std_bests = mem_std_extrema.bests %}
          {% set mem_std_worsts = mem_std_extrema.worsts %}
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set idx = loop.index0 %}
                {% set op_data = a.ops.get(op) %}
                {% if op_data and op_data.mem_stddev_kb is not none %}
                  {% set val = op_data.mem_stddev_kb %}
                  {% set key = '%.6f'|format(val) %}
                  {% set classes = [] %}
                  {% if mem_std_bests[idx] is not none and key == '%.6f'|format(mem_std_bests[idx]) %}
                    {% set classes = classes + ['metric-best'] %}
                  {% endif %}
                  {% if mem_std_worsts[idx] is not none and key == '%.6f'|format(mem_std_worsts[idx]) %}
                    {% set classes = classes + ['metric-worst'] %}
                  {% endif %}
                  {% set class_attr = classes|join(' ') %}
                  <td{% if class_attr %} class="{{ class_attr }}"{% endif %}>{{ '%.2f'|format(val) }}</td>
                {% else %}
                  <td>-</td>
                {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Median (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} median (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          {% set median_extrema = namespace(bests=[], worsts=[]) %}
          {% for op in ops %}
            {% set values = [] %}
            {% for a in compare.algos %}
              {% if a.ops.get(op) and a.ops[op].median_ms is not none %}
                {% set values = values + [a.ops[op].median_ms] %}
              {% endif %}
            {% endfor %}
            {% if values %}
              {% set median_extrema.bests = median_extrema.bests + [values|min] %}
              {% set median_extrema.worsts = median_extrema.worsts + [values|max] %}
            {% else %}
              {% set median_extrema.bests = median_extrema.bests + [None] %}
              {% set median_extrema.worsts = median_extrema.worsts + [None] %}
            {% endif %}
          {% endfor %}
          {% set median_bests = median_extrema.bests %}
          {% set median_worsts = median_extrema.worsts %}
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set idx = loop.index0 %}
                {% set op_data = a.ops.get(op) %}
                {% if op_data and op_data.median_ms is not none %}
                  {% set val = op_data.median_ms %}
                  {% set key = '%.6f'|format(val) %}
                  {% set classes = [] %}
                  {% if median_bests[idx] is not none and key == '%.6f'|format(median_bests[idx]) %}
                    {% set classes = classes + ['metric-best'] %}
                  {% endif %}
                  {% if median_worsts[idx] is not none and key == '%.6f'|format(median_worsts[idx]) %}
                    {% set classes = classes + ['metric-worst'] %}
                  {% endif %}
                  {% set class_attr = classes|join(' ') %}
                  <td{% if class_attr %} class="{{ class_attr }}"{% endif %}>{{ '%.3f'|format(val) }}</td>
                {% else %}
                  <td>-</td>
                {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Median (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} median (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          {% set mem_median_extrema = namespace(bests=[], worsts=[]) %}
          {% for op in ops %}
            {% set values = [] %}
            {% for a in compare.algos %}
              {% if a.ops.get(op) and a.ops[op].mem_median_kb is not none %}
                {% set values = values + [a.ops[op].mem_median_kb] %}
              {% endif %}
            {% endfor %}
            {% if values %}
              {% set mem_median_extrema.bests = mem_median_extrema.bests + [values|min] %}
              {% set mem_median_extrema.worsts = mem_median_extrema.worsts + [values|max] %}
            {% else %}
              {% set mem_median_extrema.bests = mem_median_extrema.bests + [None] %}
              {% set mem_median_extrema.worsts = mem_median_extrema.worsts + [None] %}
            {% endif %}
          {% endfor %}
          {% set mem_median_bests = mem_median_extrema.bests %}
          {% set mem_median_worsts = mem_median_extrema.worsts %}
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set idx = loop.index0 %}
                {% set op_data = a.ops.get(op) %}
                {% if op_data and op_data.mem_median_kb is not none %}
                  {% set val = op_data.mem_median_kb %}
                  {% set key = '%.6f'|format(val) %}
                  {% set classes = [] %}
                  {% if mem_median_bests[idx] is not none and key == '%.6f'|format(mem_median_bests[idx]) %}
                    {% set classes = classes + ['metric-best'] %}
                  {% endif %}
                  {% if mem_median_worsts[idx] is not none and key == '%.6f'|format(mem_median_worsts[idx]) %}
                    {% set classes = classes + ['metric-worst'] %}
                  {% endif %}
                  {% set class_attr = classes|join(' ') %}
                  <td{% if class_attr %} class="{{ class_attr }}"{% endif %}>{{ '%.2f'|format(val) }}</td>
                {% else %}
                  <td>-</td>
                {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Confidence Intervals and Min/Max tables -->
  <div class="island">
    <div class="stats-grid">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing 95% CI (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} CI95 (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set s = a.ops.get(op) %}
                <td>
                  {% if s and s.ci95_low_ms is not none and s.ci95_high_ms is not none %}
                    {{ '%.3f'|format(s.ci95_low_ms) }} – {{ '%.3f'|format(s.ci95_high_ms) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory 95% CI (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} CI95 (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set s = a.ops.get(op) %}
                <td>
                  {% if s and s.mem_ci95_low_kb is not none and s.mem_ci95_high_kb is not none %}
                    {{ '%.2f'|format(s.mem_ci95_low_kb) }} – {{ '%.2f'|format(s.mem_ci95_high_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Min/Max/Range (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} (min/max/range)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set s = a.ops.get(op) %}
                <td>
                  {% if s %}
                    {{ '%.3f'|format(s.min_ms) }} / {{ '%.3f'|format(s.max_ms) }} / {{ '%.3f'|format(s.range_ms) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Min/Max/Range (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} (min/max/range)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set s = a.ops.get(op) %}
                <td>
                  {% if s and s.mem_min_kb is not none and s.mem_max_kb is not none and s.mem_range_kb is not none %}
                    {{ '%.2f'|format(s.mem_min_kb) }} / {{ '%.2f'|format(s.mem_max_kb) }} / {{ '%.2f'|format(s.mem_range_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Benchmark Environment summary (from first algorithm) -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Benchmark Environment</div>
      {% set ns = namespace(env=None, done=false) %}
      {% for a in compare.algos %}
        {% if not ns.done and a.meta and a.meta.environment %}
          {% set ns.env = a.meta.environment %}
          {% set ns.done = true %}
        {% endif %}
      {% endfor %}
      {% set env = ns.env %}
      {% if env %}
        <div class="grid" style="gap:.75rem;">
          <div class="card">
            <div style="font-weight:600; margin-bottom:.35rem;">Host</div>
            <table class="kv">
              <tbody>
                <tr><td class="kv-label">CPU</td><td class="kv-value">{{ env.cpu_model or '-' }}</td></tr>
                <tr><td class="kv-label">OS</td><td class="kv-value">{{ env.os or '-' }}</td></tr>
                <tr><td class="kv-label">Python</td><td class="kv-value">{{ env.python or '-' }}</td></tr>
              </tbody>
            </table>
          </div>
          <div class="card">
            <div style="font-weight:600; margin-bottom:.35rem;">Dependencies</div>
            {% set deps = env.dependencies if env.dependencies else None %}
            {% if deps %}
            <table class="kv"><tbody>
              {% for k, v in deps.items() %}
                {% set v_str = v|string %}
                <tr>
                  <td class="kv-label">{{ k }}</td>
                  <td class="kv-value kv-mono">
                    <span title="{{ v_str }}">{{ v_str[:12] }}{% if v_str|length > 12 %}…{% endif %}</span>
                    <button type="button" data-copy="{{ v_str }}" style="margin-left:.5rem; padding:.2rem .5rem; font-size:.75rem; border-radius:.35rem; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25); color:#fff;">Copy</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody></table>
            {% else %}
              <div class="kv-sub">No dependency metadata recorded.</div>
            {% endif %}
          </div>
          <div class="card">
            <div style="font-weight:600; margin-bottom:.35rem;">Build Flags</div>
            {% set bf = env.build_flags if env.build_flags else None %}
            {% if bf %}
              {% for k, flags in bf.items() %}
                {% set block_id = 'bf_' ~ loop.index0 ~ '_' ~ k %}
                <details style="margin:.35rem 0;">
                  <summary style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                    <span>{{ k }} <span class="kv-sub">({{ flags|length }} entries)</span></span>
                    <button type="button" data-copy-target="{{ block_id }}" style="padding:.25rem .6rem; font-size:.78rem; border-radius:.35rem; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25); color:#fff;">Copy JSON</button>
                  </summary>
                  <pre id="{{ block_id }}" style="margin-top:.35rem; background:rgba(0,0,0,0.3); padding:.6rem .7rem; border-radius:.5rem; max-height:220px; overflow:auto;">{{ flags | tojson(indent=2) }}</pre>
                </details>
              {% endfor %}
            {% else %}
              <div class="kv-sub">No build flags recorded.</div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="kv-sub">Environment metadata unavailable.</div>
      {% endif %}
    </div>
  </div>

  <script>
    // Lightweight copy helpers for environment cards
    (function(){ return; /* inline LLM analysis removed
      function copyText(txt){
        if (!txt) return;
        try { navigator.clipboard.writeText(txt); } catch(e) { /* ignore */ }
      }
      function copyFromEl(id){
        var el = document.getElementById(id);
        if (!el) return;
        var t = el.innerText || el.textContent || '';
        copyText(t);
      }
      document.addEventListener('click', function(ev){
        var btn = ev.target;
        if (btn && btn.getAttribute) {
          var v = btn.getAttribute('data-copy');
          if (v != null) { copyText(v); }
          var id = btn.getAttribute('data-copy-target');
          if (id) { copyFromEl(id); }
        }
      }, false);
    })();
  </script>

  <!-- Additional statistics tables moved into the island above -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      const data = {{ compare|tojson }};
      const ops = data.kind === 'KEM' ? ['keygen','encapsulate','decapsulate'] : ['keygen','sign','verify'];
      const timingHost = document.getElementById('timing-charts');
      const memoryHost = document.getElementById('memory-charts');
      const palette = ['#1fb6b8', '#4d9dff', '#7ed957', '#ffd166', '#c792ea', '#00c2a8', '#f78c6c'];
      function makePanel(host, title){
        const wrap = document.createElement('div');
        wrap.style.background = 'rgba(0,0,0,.20)';
        wrap.style.padding = '.75rem';
        wrap.style.borderRadius = '.5rem';
        const h = document.createElement('div');
        h.textContent = title; h.style.fontWeight = '600'; h.style.marginBottom = '.5rem';
        wrap.appendChild(h);
        const canvas = document.createElement('canvas');
        canvas.style.width = '100%'; canvas.style.height = '220px';
        wrap.appendChild(canvas);
        host.appendChild(wrap);
        return canvas.getContext('2d');
      }
      ops.forEach((op, opIndex) => {
        // Timing chart
        const ctxT = makePanel(timingHost, op.charAt(0).toUpperCase()+op.slice(1));
        const labels = (data.algos[0] && data.algos[0].ops[op]) ? data.algos[0].ops[op].series.map((_,i)=>i+1) : [];
        const tDatasets = data.algos.map((a,idx)=>({
          label: a.label,
          data: (a.ops[op] && a.ops[op].series) ? a.ops[op].series : [],
          borderColor: palette[idx % palette.length],
          backgroundColor: palette[idx % palette.length]+'33',
          tension: 0.25,
          pointRadius: 1.5,
          pointStyle: 'circle',
        }));
        new Chart(ctxT, { type:'line', data:{ labels, datasets: tDatasets }, options:{ responsive:true, plugins:{legend:{position:'bottom', labels:{color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10}}}, scales:{ x:{ ticks:{color:'#fff'}}, y:{ ticks:{color:'#fff'}} } } });

        // Memory chart
        const ctxM = makePanel(memoryHost, op.charAt(0).toUpperCase()+op.slice(1));
        const mDatasets = data.algos.map((a,idx)=>({
          label: a.label,
          data: (a.ops[op] && a.ops[op].mem_series_kb) ? a.ops[op].mem_series_kb : [],
          borderColor: palette[idx % palette.length],
          backgroundColor: palette[idx % palette.length]+'33',
          tension: 0.25,
          pointRadius: 1.5,
          pointStyle: 'circle',
        }));
        new Chart(ctxM, { type:'line', data:{ labels, datasets: mDatasets }, options:{ responsive:true, plugins:{legend:{position:'bottom', labels:{color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10}}}, scales:{ x:{ ticks:{color:'#fff'}}, y:{ ticks:{color:'#fff'}} } } });
      });
    })();
  </script>

  <!-- Secret-Key Hamming Distance section (between tables and AI) -->
  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Secret-Key Hamming Distance (HD)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Mean fraction of differing bits between key pairs (per algorithm).</div>
        <canvas id="hd-bar" style="width:100%; height:260px;"></canvas>
      </div>
      <div class="card hamming-card">
        <div style="font-weight:700; margin-bottom:.5rem;">HD Statistics (fraction)</div>
        <table class="vlines hamming-table">
          <thead>
            <tr>
              <th>Algorithm</th>
              <th>Samples</th>
              <th>Mean</th>
              <th>Stddev</th>
              <th>Min</th>
              <th>Max</th>
              <th>Expected</th>
            </tr>
          </thead>
          <tbody>
            {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
            {% for a in compare.algos %}
            {% set ana = a.meta.secret_key_analysis if a.meta and a.meta.secret_key_analysis else None %}
            {% set hd = ana.hd if ana and ana.hd else None %}
            <tr>
              <td>{{ a.label }}</td>
              <td>{% if hd and hd.samples is not none %}{{ hd.samples }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.mean_fraction is not none %}{{ '%.4f'|format(hd.mean_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.std_fraction is not none %}{{ '%.4f'|format(hd.std_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.min_fraction is not none %}{{ '%.4f'|format(hd.min_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.max_fraction is not none %}{{ '%.4f'|format(hd.max_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.expected_fraction is not none %}{{ '%.4f'|format(hd.expected_fraction) }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="hint" style="margin-top:.5rem; opacity:.85; font-size:.9rem;">Expected depends on scheme/family (e.g., ≈0.5 for uniform bits; HQC uses <code>2w(1 - w/n)/n</code>).</div>
        <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
          <strong>What is Hamming distance?</strong>
          The Hamming distance between two equal‑length bitstrings is the number of bit positions where they differ.
          Here we normalise it as a fraction in [0, 1] by dividing by the bit length. For each algorithm, we generate multiple
          secret keys and compute distances across sampled key pairs to summarise randomness properties. For truly uniform
          random keys, the expected fraction is ≈0.5 (half the bits differ on average). Some schemes (e.g., constant‑weight
          constructions like HQC’s secret vectors) have different expectations; in those cases the theoretical expected fraction is shown.
          Large deviations from expectation can indicate issues in key generation, encoding, or parameter handling.
        </div>
      </div>
    </div>
  </div>

  <!-- Secret-Key Hamming Weight section -->
  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Secret-Key Hamming Weight (HW)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Mean fraction of 1-bits in secret keys (per algorithm).</div>
        <canvas id="hw-bar" style="width:100%; height:260px;"></canvas>
      </div>
      <div class="card hamming-card">
        <div style="font-weight:700; margin-bottom:.5rem;">HW Statistics (fraction)</div>
        <table class="vlines hamming-table">
          <thead>
            <tr>
              <th>Algorithm</th>
              <th>Samples</th>
              <th>Mean</th>
              <th>Stddev</th>
              <th>Min</th>
              <th>Max</th>
              <th>Expected</th>
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            {% set ana = a.meta.secret_key_analysis if a.meta and a.meta.secret_key_analysis else None %}
            {% set hw = ana.hw if ana and ana.hw else None %}
            <tr>
              <td>{{ a.label }}</td>
              <td>{% if ana and compare and compare.runs is not none %}{{ ana.samples or '-' }}{% else %}{% if hw and hw.mean_fraction is not none %}{{ ana.samples or '-' }}{% else %}-{% endif %}{% endif %}</td>
              <td>{% if hw and hw.mean_fraction is not none %}{{ '%.4f'|format(hw.mean_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.std_fraction is not none %}{{ '%.4f'|format(hw.std_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.min_fraction is not none %}{{ '%.4f'|format(hw.min_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.max_fraction is not none %}{{ '%.4f'|format(hw.max_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.expected_fraction is not none %}{{ '%.4f'|format(hw.expected_fraction) }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="hint" style="margin-top:.5rem; opacity:.85; font-size:.9rem;">Expected depends on scheme/family (uniform random bits ≈0.5; constant‑weight secrets use <code>w/n</code> where <code>w</code> is the weight and <code>n</code> the length).</div>
        <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
          <strong>What is Hamming weight?</strong>
          The Hamming weight of a bitstring is the number of 1‑bits it contains. Normalising by bit length gives a fraction in [0, 1].
          For uniformly random secrets, the expected fraction is ≈0.5. Some constructions are not uniform; for example, constant‑weight
          schemes fix exactly <em>w</em> ones among <em>n</em> bits so the expected fraction is <em>w/n</em>. Comparing observed vs expected
          helps flag RNG or encoding anomalies in key generation.
        </div>
      </div>
    </div>
  </div>

  <div class="island">
    <div class="card" style="margin-top:1.25rem;">
      <div style="font-weight:700; margin-bottom:.5rem;">Security Summary</div>
      <div style="display:flex; align-items:center; gap:.75rem; margin:.35rem 0 .75rem 0;">
        <label style="display:flex; align-items:center; gap:.35rem; cursor:pointer;">
          <input type="checkbox" id="toggle-lattice-cols" />
          <span style="font-size:.92rem; opacity:.9;">Show modeled bits alongside headline</span>
        </label>
      </div>
      <table class="vlines">
        <thead>
          <tr>
            <th>Algorithm</th>
            <th>NIST category</th>
            <th>Category floor</th>
            <th>Classical bits</th>
            <th>Quantum bits</th>
            <th>Shor breakable</th>
            <th>Estimator</th>
            <th class="col-modeled" style="display:none;">Classical (modeled)</th>
            <th class="col-modeled" style="display:none;">Quantum (modeled)</th>
          </tr>
        </thead>
        <tbody>
          {% for a in compare.algos %}
          {% set s = a.security if a.security else {} %}
          {% set headline = s.headline if s and s.headline else {} %}
          <tr>
            <td>{{ a.label }}</td>
            <td>{% if s.nist_category is not none %}{{ s.nist_category }}{% else %}-{% endif %}</td>
            <td>{% if s.category_floor is not none %}{{ s.category_floor }}{% else %}-{% endif %}</td>
            <td>{% if headline.classical_bits is number %}{{ '%.2f'|format(headline.classical_bits) }}{% else %}-{% endif %}</td>
            <td>{% if headline.quantum_bits is number %}{{ '%.2f'|format(headline.quantum_bits) }}{% else %}-{% endif %}</td>
            <td>
              {% if s.shor_breakable is not none %}
                {% if s.shor_breakable %}<span style="color:#ffb3b3;">Yes</span>{% else %}<span style="color:#b3ffb3;">No</span>{% endif %}
              {% else %}-{% endif %}
            </td>
            <td>
              {% if headline.estimator %}{{ headline.estimator }}{% else %}-{% endif %}
              {% if headline.attack %} <span class="kv-sub">({{ headline.attack }})</span>{% endif %}
            </td>
            <td class="col-modeled" style="display:none;">
              {% if headline.classical_bits_range %}
                {{ '%.2f'|format(headline.classical_bits_range[0]) }} – {{ '%.2f'|format(headline.classical_bits_range[1]) }}
              {% else %}-{% endif %}
            </td>
            <td class="col-modeled" style="display:none;">
              {% if headline.quantum_bits_range %}
                {{ '%.2f'|format(headline.quantum_bits_range[0]) }} – {{ '%.2f'|format(headline.quantum_bits_range[1]) }}
              {% else %}-{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
        <strong>How to read this:</strong> “Bits” are estimated work factors: higher is better (harder to break). Classical bits approximate cost under classical attacks; quantum bits under realistic quantum models. “Shor breakable” highlights schemes vulnerable to Shor’s algorithm (e.g., RSA, ECC). Values depend on estimator settings (profile, physical error rates, etc.).
      </div>
    </div>
    <!-- Security Model Details (Lattice/ISD/Hash/MQ) -->
    {% set security_chart = namespace(labels=[], classical=[], quantum=[]) %}
    {% for algo in compare.algos %}
      {% set sec = algo.security if algo.security else {} %}
      {% set head = sec.headline if sec and sec.headline else {} %}
      {% if head.classical_bits is number or head.quantum_bits is number %}
        {% set security_chart.labels = security_chart.labels + [algo.label] %}
        {% set security_chart.classical = security_chart.classical + [head.classical_bits if head.classical_bits is number else None] %}
        {% set security_chart.quantum = security_chart.quantum + [head.quantum_bits if head.quantum_bits is number else None] %}
      {% endif %}
    {% endfor %}
    <div class="card security-model-card" style="margin-top:1.25rem;">
      <div class="security-model-header">
        <div>
          <div class="security-model-title">Security Model Details</div>
          <div class="security-model-subtitle">Estimator inputs, dominant attacks, and key dimensional parameters for each scheme.</div>
        </div>
      </div>
      {% if security_chart.labels %}
        {% set security_chart_payload = {
          "type": "bar",
          "title": "Estimated security bits",
          "labels": security_chart.labels,
          "datasets": [
            {"label": "Classical bits", "data": security_chart.classical},
            {"label": "Quantum bits", "data": security_chart.quantum}
          ],
          "x": {"title": "Algorithm"},
          "y": {"title": "Estimated bits", "beginAtZero": True},
          "options": {"plugins": {"legend": {"position": "bottom"}}}
        } %}
        <figure class="security-chart" data-chart='{{ security_chart_payload|tojson }}'>
          <figcaption>Estimated work factors (bits). Higher bars indicate stronger resistance under the modeled attack cost assumptions.</figcaption>
        </figure>
      {% endif %}
      <div class="security-detail-grid">
        {% for a in compare.algos %}
        {% set s = a.security if a.security else {} %}
        {% set headline = s.headline if s and s.headline else {} %}
        {% set rows = s.detail_rows if s and s.detail_rows else [] %}
        <div class="security-detail-card">
          <div class="security-detail-header">
            <div class="security-detail-name">{{ a.label }}</div>
            <div class="security-detail-summary">
              <div class="meta-pair">
                <div class="meta-label">Model</div>
                <div class="meta-value">{% if headline.model %}{{ headline.model }}{% else %}-{% endif %}</div>
              </div>
              <div class="meta-pair">
                <div class="meta-label">Best attack</div>
                <div class="meta-value">{% if headline.attack %}{{ headline.attack }}{% else %}-{% endif %}</div>
              </div>
              {% if headline.classical_bits is number %}
              <div class="meta-pair">
                <div class="meta-label">Classical bits</div>
                <div class="meta-value">{{ '%.1f'|format(headline.classical_bits) }}</div>
              </div>
              {% endif %}
              {% if headline.quantum_bits is number %}
              <div class="meta-pair">
                <div class="meta-label">Quantum bits</div>
                <div class="meta-value">{{ '%.1f'|format(headline.quantum_bits) }}</div>
              </div>
              {% endif %}
            </div>
            {% if headline.estimator %}
            <div class="meta-note">Estimator: {{ headline.estimator }}</div>
            {% endif %}
          </div>
          {% if rows %}
          <ul class="metrics-list">
            {% for row in rows %}
            <li>
              <span class="metric-label">{{ row[0] }}</span>
              <span class="metric-value">{{ row[1] }}</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="metrics-empty">Detailed parameters not provided.</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <div class="kv-sub" style="margin-top:.4rem;">
        Models: Kyber/Dilithium → Module‑LWE BKZ (primal/dual/hybrid); Falcon → NTRU BKZ; HQC → ISD (Stern/BJMM);
        SPHINCS+/XMSS → hash bounds; MAYO → MQ checks (rank/minrank). Detailed curves and constants appear in raw JSON
        under "details.*" blocks (e.g., details.module_lwe_*, details.falcon_bkz_model).
      </div>
    </div>
    <div class="card security-notes-card" style="margin-top:1.25rem;">
      <div class="security-model-header">
        <div>
          <div class="security-model-title">Security Notes</div>
          <div class="security-model-subtitle">Curated context on estimator choices, literature references, and caveats surfaced for each scheme.</div>
        </div>
      </div>
      {% set ns = namespace(found=False) %}
      <ul class="security-notes-list">
        {% for a in compare.algos %}
          {% set s = a.security if a.security else {} %}
          {% set headline = s.headline if s and s.headline else {} %}
          {% set notes = headline.notes if headline and headline.notes else [] %}
          {% if notes %}
            {% set ns.found = True %}
            {% set has_chip = (s.nist_category is not none) or headline.model or headline.attack %}
            <li class="security-notes-item">
              <span class="note-name">{{ a.label }}:</span>
              {% if has_chip %}
              <span class="note-chipbox">
                {% if s.nist_category is not none %}<span class="note-chip">NIST L{{ s.nist_category }}</span>{% endif %}
                {% if headline.model %}<span class="note-chip">{{ headline.model }}</span>{% endif %}
                {% if headline.attack %}<span class="note-chip">{{ headline.attack }}</span>{% endif %}
              </span>
              {% endif %}
              {% if headline.estimator %}
              <span class="note-estimator">Estimator: {{ headline.estimator }}</span>
              {% endif %}
              <ul class="note-points">
                {% for note in notes %}
                <li class="note-point">{{ note }}</li>
                {% endfor %}
              </ul>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
      {% if not ns.found %}
        <div class="notes-empty">No additional notes for these algorithms.</div>
      {% endif %}
    </div>
  </div>
  <script>
    // Toggle modeled columns in Security Summary
    (function(){
      const cb = document.getElementById('toggle-lattice-cols');
      if (!cb) return;
      function update(){
        const show = !!cb.checked;
        document.querySelectorAll('.col-modeled').forEach(el => { el.style.display = show ? '' : 'none'; });
      }
      cb.addEventListener('change', update);
      update();
    })();
  </script>

  <!-- Projected runtimes (runtime scaling) -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Projected Runtimes (by device)</div>
      <div id="runtime-charts" class="grid"></div>
    </div>
  </div>

  <script>
    (function(){
      const data = {{ compare|tojson }};
      const ops = data.kind === 'KEM' ? ['keygen','encapsulate','decapsulate'] : ['keygen','sign','verify'];
      const host = document.getElementById('runtime-charts');
      if (!host) return;
      // Collect available target devices across algos/ops
      const deviceSet = new Set();
      for (const a of (data.algos||[])) {
        for (const op of ops) {
          const s = a.ops && a.ops[op];
          const rs = s && s.runtime_scaling;
          if (rs && rs.predictions) {
            Object.keys(rs.predictions).forEach(k => deviceSet.add(k));
          }
        }
      }
      const devices = Array.from(deviceSet).sort();
      if (!devices.length) {
        const msg = document.createElement('div');
        msg.className = 'kv-sub';
        msg.textContent = 'Runtime scaling unavailable (no device predictions).';
        host.appendChild(msg);
        return;
      }
      const palette = ['#1fb6b8','#ffd166','#4d9dff'];
      function addDeviceChart(device){
        const wrap = document.createElement('div');
        wrap.className = 'card';
        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.style.marginBottom = '.25rem';
        title.textContent = `Device: ${device}`;
        wrap.appendChild(title);
        const canvas = document.createElement('canvas');
        canvas.style.width = '100%';
        canvas.style.height = '260px';
        wrap.appendChild(canvas);
        // Labels are algorithm display names
        const labels = (data.algos||[]).map(a => a.label || a.name || '?');
        const datasets = ops.map((op, idx) => {
          const series = [];
          for (const a of (data.algos||[])) {
            const rs = a.ops && a.ops[op] && a.ops[op].runtime_scaling;
            const pred = rs && rs.predictions && rs.predictions[device];
            series.push(pred && typeof pred.predicted_ms === 'number' ? pred.predicted_ms : null);
          }
          return {
            label: op.charAt(0).toUpperCase()+op.slice(1),
            data: series,
            backgroundColor: palette[idx % palette.length],
          };
        });
        try {
          const ctx = canvas.getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'ms' }, ticks:{ color:'#fff' } },
                x: { ticks:{ color:'#fff' } }
              },
              plugins: { legend: { position:'bottom', labels:{ color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10 } } },
              animation: false,
              normalized: true,
            }
          });
        } catch (e) {}
        host.appendChild(wrap);
      }
      devices.forEach(addDeviceChart);
    })();
  </script>

  <!-- Brute-Force Baseline (educational) -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Brute-Force Baseline (educational)</div>
      <div class="grid">
        {% for a in compare.algos %}
        {% set s = a.security if a.security else {} %}
        {% set bf = s.bruteforce if s and s.bruteforce else None %}
        <div class="card" style="min-width:260px;">
          <div style="font-weight:700; margin-bottom:.35rem;">{{ a.label }}</div>
          {% if bf %}
            <table class="kv"><tbody>
              <tr><td class="kv-label">Model</td><td class="kv-value">{{ bf.model }}</td></tr>
              <tr><td class="kv-label">Search space</td><td class="kv-value">2^{{ '%.0f'|format(bf.space_bits) if bf.space_bits is number else bf.space_bits }}</td></tr>
              <tr><td class="kv-label">Rate unit</td><td class="kv-value">{{ bf.rate_unit }}</td></tr>
            </tbody></table>
            <div style="margin-top:.5rem; font-weight:600;">Time to succeed (years)</div>
            <table class="vlines" style="margin-top:.25rem;">
              <thead>
                <tr>
                  <th style="text-align:left;">Rate</th>
                  <th>Years</th>
                  <th>log10</th>
                </tr>
              </thead>
              <tbody>
                {% for rate in bf.rates %}
                {% set key = (rate|string) %}
                {% set row = bf.time_years[key] if bf.time_years and key in bf.time_years else None %}
                <tr>
                  <td style="text-align:left;">
                    {% if bf.rate_unit == 'cores' %}{{ rate|int }} cores{% else %}{{ '%.0e'|format(rate) }} t/s{% endif %}
                  </td>
                  <td>{% if row and row.sci %}{{ row.sci }}{% else %}-{% endif %}</td>
                  <td>{% if row and row.log10 is not none %}{{ '%.2f'|format(row.log10) }}{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% if bf.assumptions and bf.assumptions.rationale %}
              <div class="kv-sub" style="margin-top:.35rem;">{{ bf.assumptions.rationale }}</div>
            {% endif %}
          {% else %}
            <div class="kv-sub">No brute-force baseline available.</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <div class="kv-sub" style="margin-top:.5rem; opacity:.85;">Note: This baseline is educational. Real parameters are astronomically out of reach; see docs/security/brute-force-baseline.md.</div>
    </div>
  </div>

  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const el = document.getElementById('hd-bar');
      if (!el || !compareData || !Array.isArray(compareData.algos)) return;
      const rows = [];
      for (const a of compareData.algos) {
        const ana = a && a.meta && a.meta.secret_key_analysis;
        const hd = ana && ana.hd;
        if (hd && hd.mean_fraction != null) {
          rows.push({
            label: a.label || a.name || '?',
            mean: +hd.mean_fraction,
            exp: (hd.expected_fraction != null ? +hd.expected_fraction : null)
          });
        }
      }
      if (!rows.length) {
        // No data: show a subtle message
        const msg = document.createElement('div');
        msg.textContent = 'No HD data available for the selected algorithms.';
        msg.style.opacity = '0.9';
        msg.style.fontSize = '.95rem';
        el.parentElement.appendChild(msg);
        return;
      }
      const labels = rows.map(r => r.label);
      const means = rows.map(r => r.mean);
      const expects = rows.map(r => r.exp);
      const hasAnyExpected = expects.some(v => v != null);
      try {
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'HD mean fraction',
                data: means,
                backgroundColor: '#1fb6b8',
              },
              ...(hasAnyExpected ? [{
                label: 'Expected fraction',
                data: expects,
                backgroundColor: '#ffd166',
                borderColor: '#ffd166',
              }] : [])
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                title: { display: true, text: 'Fraction' },
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 1,
                ticks: { color: '#fff', callback: (v) => (typeof v === 'number' ? v.toFixed(2) : v) }
              },
              x: { ticks: { color: '#fff' } }
            },
            plugins: {
              legend: { position: 'bottom', labels: { color: '#fff', usePointStyle: true, boxWidth: 10, boxHeight: 10 } },
              tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + (typeof ctx.parsed.y === 'number' ? ctx.parsed.y.toFixed(4) : ctx.parsed.y) } }
            },
            animation: false,
            normalized: true,
          }
        });
      } catch (e) { /* ignore */ }
    })();
  </script>

  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const el = document.getElementById('hw-bar');
      if (!el || !compareData || !Array.isArray(compareData.algos)) return;
      const rows = [];
      for (const a of compareData.algos) {
        const ana = a && a.meta && a.meta.secret_key_analysis;
        const hw = ana && ana.hw;
        if (hw && hw.mean_fraction != null) {
          rows.push({
            label: a.label || a.name || '?',
            mean: +hw.mean_fraction,
            exp: (hw.expected_fraction != null ? +hw.expected_fraction : null)
          });
        }
      }
      if (!rows.length) {
        const msg = document.createElement('div');
        msg.textContent = 'No HW data available for the selected algorithms.';
        msg.style.opacity = '0.9';
        msg.style.fontSize = '.95rem';
        el.parentElement.appendChild(msg);
        return;
      }
      const labels = rows.map(r => r.label);
      const means = rows.map(r => r.mean);
      const expects = rows.map(r => r.exp);
      const hasAnyExpected = expects.some(v => v != null);
      try {
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'HW mean fraction',
                data: means,
                backgroundColor: '#7ed957',
              },
              ...(hasAnyExpected ? [{
                label: 'Expected fraction',
                data: expects,
                backgroundColor: '#ffd166',
                borderColor: '#ffd166',
              }] : [])
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                title: { display: true, text: 'Fraction' },
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 1,
                ticks: { color: '#fff', callback: (v) => (typeof v === 'number' ? v.toFixed(2) : v) }
              },
              x: { ticks: { color: '#fff' } }
            },
            plugins: {
              legend: { position: 'bottom', labels: { color: '#fff', usePointStyle: true, boxWidth: 10, boxHeight: 10 } },
              tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + (typeof ctx.parsed.y === 'number' ? ctx.parsed.y.toFixed(4) : ctx.parsed.y) } }
            },
            animation: false,
            normalized: true,
          }
        });
      } catch (e) { /* ignore */ }
    })();
  </script>

  <!-- LLM Analysis section removed; using floating chatbot only -->

  

  <!-- HTML sanitization lib -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <script>
    (function(){ return; /* inline LLM analysis removed */
      const compareData = {{ compare|tojson }};
      const out = document.getElementById('llm-analysis-output');
      const btn = document.getElementById('llm-generate');
      const btnRe = document.getElementById('llm-regenerate');
      const btnOpen = document.getElementById('llm-open');
      const err = document.getElementById('llm-analysis-error');
      const hint = document.getElementById('llm-provider-hint');
      const reqEl = document.getElementById('llm-user-request');
      let lastAnalysisHTML = '';
      const sanitizeOptions = window.DOMPurify ? { ADD_ATTR: ['data-chart'] } : undefined;
      // Modal elements
      const modal = document.getElementById('llm-modal');
      const modalFrame = document.getElementById('llm-modal-frame');
      const modalClose = document.getElementById('llm-modal-close');
      const modalPrint = document.getElementById('llm-modal-print');

      async function runAnalysis() {
        err.style.display = 'none';
        err.textContent = '';
        btn.disabled = true; btnRe.disabled = true;
        const prevHTML = out.innerHTML;
        out.textContent = 'Generating analysis...';
        try {
          const res = await fetch('/api/analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compare: compareData, request: (reqEl && reqEl.value && reqEl.value.trim()) ? reqEl.value.trim() : undefined })
          });
          const data = await res.json();
          if (!data || data.ok === false) {
            throw new Error((data && data.error) || 'Analysis failed');
          }
          const provider = (data.provider || 'auto');
          const model = (data.model || '');
          const usedFallback = !!data.used_fallback;
          if (hint) {
            hint.textContent = 'Provider: ' + provider + (model ? (' | ' + model) : '') + (usedFallback ? ' (fallback)' : '');
          }
          const text = (data.analysis || '').trim();
          if (text) {
            try {
              const html = text; // server returns HTML only
              const sanitized = window.DOMPurify ? DOMPurify.sanitize(html, sanitizeOptions) : html;
              lastAnalysisHTML = sanitized;
              out.innerHTML = sanitized;
              if (window.renderLLMCharts) { window.renderLLMCharts(out); }
            } catch (e) {
              out.textContent = text; // fallback to plain text
              lastAnalysisHTML = out.textContent;
            }
          } else {
            out.textContent = 'No analysis returned.';
            lastAnalysisHTML = '';
          }
          // Surface provider error inline if we fell back
          if (usedFallback && data.error) {
            err.style.display = 'block';
            let msg = 'Provider error: ' + String(data.error);
            if (data.meta && data.meta.endpoint) {
              msg += ' | endpoint: ' + String(data.meta.endpoint);
            }
            err.textContent = msg;
          } else {
            err.style.display = 'none';
            err.textContent = '';
          }
          btnRe.style.display = 'inline-block';
          btnOpen.style.display = (lastAnalysisHTML && lastAnalysisHTML.trim()) ? 'inline-block' : 'none';
        } catch (e) {
          out.innerHTML = prevHTML;
          if (window.renderLLMCharts) { window.renderLLMCharts(out); }
          err.style.display = 'block';
          err.textContent = String(e);
        } finally {
          btn.disabled = false; btnRe.disabled = false;
        }
      }

      btn.addEventListener('click', runAnalysis);
      btnRe.addEventListener('click', runAnalysis);
      btnOpen.addEventListener('click', () => {
        try {
          // Show modal and submit a POST targeted to the iframe
          if (!modal || !modalFrame) return;
          modal.style.display = 'flex';
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/analysis/html';
          form.target = 'llmModalFrame';
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'data';
          input.value = JSON.stringify({
            compare: compareData,
            request: (reqEl && reqEl.value && reqEl.value.trim()) ? reqEl.value.trim() : undefined
          });
          form.appendChild(input);
          document.body.appendChild(form);
          form.submit();
          setTimeout(() => form.remove(), 1000);
        } catch (e) { /* ignore */ }
      });

      function hideModal() {
        if (modal) modal.style.display = 'none';
        if (modalFrame) {
          try { modalFrame.src = 'about:blank'; } catch (e) {}
        }
      }
      if (modalClose) modalClose.addEventListener('click', hideModal);
      if (modal) modal.addEventListener('click', (ev) => {
        if (ev.target === modal) hideModal();
      });
      if (modalPrint) modalPrint.addEventListener('click', () => {
        try { if (modalFrame && modalFrame.contentWindow) modalFrame.contentWindow.print(); } catch (e) {}
      });
      // Auto-run disabled; use floating widget to trigger analysis
    */ })();
  </script>
  <script>
    (function() {
      function bootCharts() {
        if (window.renderLLMCharts) {
          window.renderLLMCharts(document.body);
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bootCharts);
      } else {
        bootCharts();
      }
    })();
  </script>

  <!-- Raw exports section -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Raw Exports</div>
      <details style="margin-top:.25rem;">
        <summary style="cursor:pointer;">View raw JSON</summary>
        <div class="export-grid">
          {% for a in compare.algos %}
          <div class="export-link-card">
            <div style="font-weight:700; margin-bottom:.35rem;">{{ a.label }}</div>
            {% set ex = a.exports if a.exports else (a.meta.exports if a.meta and a.meta.exports else None) %}
            {% if ex and ex.json %}
              <div><a href="/{{ ex.json }}" target="_blank">Open JSON summary</a></div>
            {% else %}
              <div style="opacity:.8;">No JSON export available.</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </details>

      <details style="margin-top:1rem;">
        <summary style="cursor:pointer;">View raw data (one run)</summary>
        <div class="export-grid">
          {% for a in compare.algos %}
          <div class="export-link-card">
            <div style="font-weight:700; margin-bottom:.35rem;">{{ a.label }}</div>
            {% set ex = a.exports if a.exports else (a.meta.exports if a.meta and a.meta.exports else None) %}
            {% if ex and ex.trace %}
              <div><a href="/{{ ex.trace }}" target="_blank">Open raw trace</a></div>
            {% else %}
              <div style="opacity:.8;">No trace export available.</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </details>
    </div>
  </div>
  </main>
</body>
</html>
