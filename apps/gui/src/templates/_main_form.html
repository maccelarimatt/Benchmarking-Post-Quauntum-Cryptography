{% import '_form_macros.html' as form %}
{% set operation = (selected_operation or 'compare') %}
{% set compare_kind = (compare_kind or 'KEM') %}
{% set compare_mode = (compare_mode or 'pair') %}
<style>
  /* Algorithm tiles */
  #cmp_algo_list { border-top: 1px solid rgba(255,255,255,.22); border-bottom: 1px solid rgba(255,255,255,.18); }
  .algo-lists { position: relative; transition: height 200ms ease; }
  .fade-layer { position: absolute; inset: 0; opacity: 0; transition: opacity 180ms ease; pointer-events: none; }
  .fade-layer.is-active { opacity: 1; pointer-events: auto; }
  /* Keep checkbox card sizes constant by fixing item width */
  .algo-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:.6rem; justify-content: stretch; align-content: start; }
  .algo-option {
    position: relative;
    display:flex;
    align-items:center;
    gap:.55rem;
    background: rgba(10,14,21,0.55);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius:.9rem;
    padding:.65rem .8rem;
    cursor:pointer;
    overflow:hidden;
    transition: transform .28s ease, border-color .2s ease, box-shadow .3s ease;
  }
  .algo-option::after {
    content:"";
    position:absolute;
    inset:0;
    background: linear-gradient(135deg, rgba(31,182,184,0.18), transparent 60%);
    opacity:0;
    transition: opacity .3s ease;
    pointer-events:none;
  }
  .algo-option:hover {
    border-color: rgba(31,182,184,0.4);
    box-shadow: 0 14px 26px rgba(12,40,56,0.28);
  }
  .algo-option:hover::after { opacity:1; }
  .algo-option input[type="checkbox"] { flex:0 0 auto; }
  .algo-option span { position: relative; z-index: 1; }
  /* Inline form error for selection validation */
  .form-error { display:none; margin-top:.5rem; color:#ffdddd; background:#902; padding:.5rem .7rem; border-radius:.5rem; }
  /* Run button tooltip shown only when disabled and hovered */
  .run-wrapper { position: relative; display: inline-block; }
  .run-tooltip {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,.85);
    color: #fff;
    font-size: .85rem;
    padding: .4rem .6rem;
    border-radius: .35rem;
    white-space: nowrap;
    box-shadow: 0 4px 10px rgba(0,0,0,.25);
    opacity: 0;
    pointer-events: none;
    transition: opacity .15s ease, transform .15s ease;
    z-index: 5;
  }
  .run-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: rgba(0,0,0,.85) transparent transparent transparent;
  }
  .run-wrapper:hover button:disabled + .run-tooltip { opacity: 1; }
</style>
<form method="POST" action="/execute" id="main-form">
  <input type="hidden" name="operation" value="compare" />
  <div class="form-grid" style="max-width: 820px; margin: 0 auto;">
    

    <div id="compare-fields" style="display: contents;">
      <!-- Top row: Algorithm Type, Runs, Message Size (SIG) -->
      <div class="field" style="grid-column: span 4;">
        <label for="cmp_kind">Algorithm Type</label>
        <select id="cmp_kind" name="kind">
          <option value="KEM" {% if compare_kind != 'SIG' %}selected{% endif %}>KEM</option>
          <option value="SIG" {% if compare_kind == 'SIG' %}selected{% endif %}>SIG</option>
        </select>
      </div>
      <div class="field" style="grid-column: span 6;">
        <label for="security_category">NIST security category</label>
        {% set selected_level = selected_security_category|default(None) %}
        <select id="security_category" name="security_category">
          {% for value, label in security_category_choices %}
            {% set is_selected = (selected_level is none and value == '') or (selected_level is not none and value and selected_level == value|int) %}
            <option value="{{ value }}" {% if is_selected %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <div class="hint">Leave at default to use each adapter&rsquo;s preferred parameters.</div>
      </div>
      {{ form.number_field('cmp_runs', 'runs', 'Runs', default_runs or 10, column='span 2') }}
      <div class="field" style="grid-column: span 6;" id="cmp_msg_field">
        <label for="cmp_msg_select">Message size (SIG)</label>
        <select id="cmp_msg_select" name="message_size">
          {% set msg_default = (default_message_size or 1024) | int %}
          {% for size in [64,128,256,512,1024,2048,4096] %}
            <option value="{{ size }}" {% if msg_default == size %}selected{% endif %}>{{ size }} bytes</option>
          {% endfor %}
        </select>
      </div>

      <!-- Algorithms list (checkboxes) -->
      <div class="field field--full" id="cmp_algo_list" style="padding-top:.5rem; padding-bottom:.6rem; margin-top:.2rem; margin-bottom:0;">
        <label>Algorithms</label>
        <div id="cmp_algo_list_body" class="algo-lists">
        <div id="cmp_algos_kem" class="fade-layer is-active algo-grid">
          {% for name in algos %}
            {% if kinds[name] == 'KEM' %}
            <label class="algo-option">
              <input type="checkbox" name="algos" value="{{name}}" />
              <span>{{ display_names.get(name, name) }}</span>
            </label>
            {% endif %}
          {% endfor %}
        </div>
        <div id="cmp_algos_sig" class="fade-layer algo-grid">
          {% for name in algos %}
            {% if kinds[name] == 'SIG' %}
            <label class="algo-option">
              <input type="checkbox" name="algos" value="{{name}}" />
              <span>{{ display_names.get(name, name) }}</span>
            </label>
            {% endif %}
          {% endfor %}
        </div>
        </div>
        <div id="algo-error" class="form-error" role="alert" aria-live="polite">Please select at least one algorithm to run.</div>
      </div>

      <!-- Cold starts -->
      <div class="field" style="grid-column: span 10; margin-top:-0.35rem;">
        <div class="checkbox-row">
          <input id="cmp_cold" type="checkbox" name="cold" checked />
          <label for="cmp_cold" style="margin:0;">Cold starts (fresh process per run)</label>
        </div>
      </div>

      <!-- Functional tests (ACVP) -->
      <div class="field" style="grid-column: span 10; margin-top:-0.35rem;">
        <div class="checkbox-row">
          <input id="cmp_tests" type="checkbox" name="tests" />
          <label for="cmp_tests" style="margin:0;">Run functional tests (ACVP vectors)</label>
        </div>
        <div class="hint">Runs liboqs vector checks when available. If binaries or vectors are missing, results show as “skipped”.</div>
      </div>

      <!-- Security estimator (unchanged, placed below) -->
      <div class="field field--full" style="margin-top:.4rem;">
        <div style="font-weight:600;">Security estimator</div>
        <div class="hint">Optional: configure the estimator inputs used for security summaries.</div>
      </div>
      <div class="field" style="grid-column: span 6;">
        <div class="checkbox-row">
          <input id="sec_adv_cmp" type="checkbox" name="sec_adv" {% if security_form.sec_adv %}checked{% endif %}/>
          <label for="sec_adv_cmp" style="margin:0;">Advanced lattice estimator</label>
        </div>
      </div>
      <div class="field" style="grid-column: span 6;">
        <div class="checkbox-row">
          <input id="sec_rsa_phys_cmp" type="checkbox" name="sec_rsa_phys" {% if security_form.sec_rsa_phys %}checked{% endif %}/>
          <label for="sec_rsa_phys_cmp" style="margin:0;">Include RSA surface-code overhead</label>
        </div>
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="sec_profile_cmp">Security profile</label>
        <select id="sec_profile_cmp" name="sec_profile">
          {% for profile in security_profile_choices %}
            <option value="{{ profile }}" {% if security_form.sec_profile == profile %}selected{% endif %}>{{ profile|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="sec_phys_error_rate_cmp">Physical error rate</label>
        <input id="sec_phys_error_rate_cmp" name="sec_phys_error_rate" type="number" step="any" min="0" value="{{ security_form.sec_phys_error_rate }}" />
        <div class="hint">Probability per physical operation.</div>
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="sec_cycle_time_ns_cmp">Cycle time (ns)</label>
        <input id="sec_cycle_time_ns_cmp" name="sec_cycle_time_ns" type="number" step="any" min="0" value="{{ security_form.sec_cycle_time_ns }}" />
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="sec_fail_prob_cmp">Target fail probability</label>
        <input id="sec_fail_prob_cmp" name="sec_fail_prob" type="number" step="any" min="0" value="{{ security_form.sec_fail_prob }}" />
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="quantum_arch_cmp">Quantum arch preset</label>
        <select id="quantum_arch_cmp" name="quantum_arch">
          {% for value, label in quantum_arch_choices %}
            <option value="{{ value }}" {% if security_form.quantum_arch == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="rsa_model_cmp">RSA resource model</label>
        <select id="rsa_model_cmp" name="rsa_model">
          {% for model in rsa_model_choices %}
            <option value="{{ model }}" {% if security_form.rsa_model == model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
        <div class="hint">Applies to RSA baselines only.</div>
      </div>
    </div>
  </div>
  <div class="actions">
    <button class="muted-btn" type="reset">Reset</button>
    <span class="run-wrapper">
      <button type="submit" id="run-btn" disabled>Run</button>
      <span class="run-tooltip" id="run-tooltip">Select at least one algorithm</span>
    </span>
  </div>
</form>

<script>
  (function(){
    const kinds = {{ kinds|tojson }};
    const compareFields = document.getElementById('compare-fields');
    const cmpKind = document.getElementById('cmp_kind');
    const cmpMsgField = document.getElementById('cmp_msg_field');
    const cmpMsgSelect = document.getElementById('cmp_msg_select');
    const cmpAlgosKem = document.getElementById('cmp_algos_kem');
    const cmpAlgosSig = document.getElementById('cmp_algos_sig');
    const cmpAlgoListBody = document.getElementById('cmp_algo_list_body');

    const mainForm = document.getElementById('main-form');
    const loadingOverlay = document.getElementById('loading-overlay');
    const algoError = document.getElementById('algo-error');
    const runBtn = mainForm ? mainForm.querySelector('button[type="submit"]') : null;

    function showLoadingOverlay(){
      if (!loadingOverlay) return;
      const stageEl = document.getElementById('loading-stage');
      const detailEl = document.getElementById('loading-detail');
      const barEl = document.getElementById('loading-progress');
      if (stageEl) stageEl.textContent = 'Setting Up Environment';
      if (detailEl) detailEl.textContent = '';
      if (barEl) barEl.style.width = '2%';
      loadingOverlay.removeAttribute('hidden');
      loadingOverlay.classList.add('is-visible');
    }

    function updateLoading(stage, detail, percent){
      const stageEl = document.getElementById('loading-stage');
      const detailEl = document.getElementById('loading-detail');
      const barEl = document.getElementById('loading-progress');
      if (typeof stage === 'string' && stageEl) stageEl.textContent = stage;
      if (typeof detail === 'string' && detailEl) detailEl.textContent = detail;
      if (typeof percent === 'number' && barEl) barEl.style.width = Math.min(100, Math.max(0, percent)) + '%';
    }

    function hideLoadingOverlay(){
      if (!loadingOverlay) return;
      loadingOverlay.classList.remove('is-visible');
      // Allow fade-out to complete before hiding from layout again
      setTimeout(function(){
        if (!loadingOverlay.classList.contains('is-visible')) {
          loadingOverlay.setAttribute('hidden', 'hidden');
        }
      }, 220);
    }

    function refreshSingleSection(){
      // single-run UI removed
    }

    function setAlgoListHeight(target){
      if (!cmpAlgoListBody || !target) return;
      // Measure the intrinsic content height of the target layer.
      // Because .fade-layer uses `inset:0` (bottom:0), its scrollHeight can equal the
      // container height rather than content height. Temporarily set bottom:auto to
      // let it size to its content, measure, then restore.
      const prevBottom = target.style.bottom;
      target.style.bottom = 'auto';
      const h = target.scrollHeight;
      target.style.bottom = prevBottom || '';
      cmpAlgoListBody.style.height = h + 'px';
    }

    function getActiveAlgoLayer(){
      const isSig = (cmpKind && cmpKind.value === 'SIG');
      return isSig ? cmpAlgosSig : cmpAlgosKem;
    }

    function countSelected(){
      const layer = getActiveAlgoLayer();
      if (!layer) return 0;
      const inputs = layer.querySelectorAll('input[name="algos"]:checked');
      return inputs ? inputs.length : 0;
    }

    function refreshRunState(){
      if (!runBtn) return;
      const hasSelection = countSelected() > 0;
      runBtn.disabled = !hasSelection;
    }

    function refreshCompareSection(){
      if (!cmpKind) return;
      const isCompare = true; // Always compare mode on main page
      const isSig = (cmpKind.value === 'SIG');
      if (cmpMsgSelect) cmpMsgSelect.disabled = !isSig;
      if (cmpMsgField) cmpMsgField.style.opacity = isSig ? '1' : '.65';
      if (cmpAlgosKem && cmpAlgosSig) {
        if (isSig) {
          cmpAlgosSig.classList.add('is-active');
          cmpAlgosKem.classList.remove('is-active');
          requestAnimationFrame(() => setAlgoListHeight(cmpAlgosSig));
        } else {
          cmpAlgosKem.classList.add('is-active');
          cmpAlgosSig.classList.remove('is-active');
          requestAnimationFrame(() => setAlgoListHeight(cmpAlgosKem));
        }
      }
      refreshRunState();
    }

    hideLoadingOverlay();

    window.addEventListener('pageshow', function(event){
      if (event && event.persisted) {
        hideLoadingOverlay();
      }
    });

    function refreshMode(){
      const isCompare = opSelect && opSelect.value === 'compare';
      toggleSection(singleFields, !isCompare);
      toggleSection(compareFields, isCompare);
      refreshSingleSection();
      refreshCompareSection();
    }

    // single-run UI removed
    if (cmpKind) cmpKind.addEventListener('change', function(){
      if (algoError) algoError.style.display = 'none';
      refreshCompareSection();
    });
    if (cmpAlgoListBody) cmpAlgoListBody.addEventListener('change', function(e){
      const t = e.target;
      if (t && t.name === 'algos') {
        if (algoError) algoError.style.display = 'none';
        refreshRunState();
      }
    });
    if (mainForm) {
      mainForm.addEventListener('submit', async function(ev){
        if (countSelected() === 0) {
          if (algoError) algoError.style.display = 'block';
          if (ev) ev.preventDefault();
          return false;
        }
        if (typeof mainForm.checkValidity === 'function' && !mainForm.checkValidity()) {
          if (ev) ev.preventDefault();
          return false;
        }
        if (ev) ev.preventDefault();
        window.requestAnimationFrame(showLoadingOverlay);
        try {
          const fd = new FormData(mainForm);
          // Ensure compare mode
          if (!fd.get('operation')) fd.set('operation', 'compare');
          const resp = await fetch('/execute_async', { method: 'POST', body: fd });
          if (!resp.ok) throw new Error('Failed to start job');
          const data = await resp.json();
          if (!data || !data.job_id) throw new Error(data && data.error ? data.error : 'Invalid response');
          const jobId = data.job_id;
          const es = new EventSource('/progress/' + encodeURIComponent(jobId));
          const handler = function(evt) {
            try {
              const msg = JSON.parse(evt.data || '{}');
              if (!msg || msg.ok === false) return;
              updateLoading(msg.stage || '', msg.detail || '', typeof msg.percent === 'number' ? msg.percent : undefined);
              if (msg.status === 'done') {
                es.close();
                // Navigate to the rendered results for this job
                window.location.href = '/job/' + encodeURIComponent(jobId) + '/view';
              }
              if (msg.status === 'error') {
                es.close();
                updateLoading('Error', msg.detail || 'Job failed', 100);
                setTimeout(hideLoadingOverlay, 1200);
              }
            } catch (e) { /* ignore parse errors */ }
          }
          es.addEventListener('progress', handler);
          es.onerror = function(){ /* keep connection; SSE auto-retries */ };
        } catch (e) {
          updateLoading('Error', (e && e.message) ? e.message : 'Failed to start job', 100);
          setTimeout(hideLoadingOverlay, 1200);
        }
        return false;
      });
      mainForm.addEventListener('reset', function(){
        setTimeout(function(){
          // Ensure UI reflects reset defaults (KEM becomes active again)
          refreshCompareSection();
          refreshRunState();
          if (algoError) algoError.style.display = 'none';
        }, 0);
      });
    }

    // Initialize height to active list
    setTimeout(function(){
      if (cmpAlgosKem && cmpAlgosKem.classList.contains('is-active')) setAlgoListHeight(cmpAlgosKem);
      else if (cmpAlgosSig && cmpAlgosSig.classList.contains('is-active')) setAlgoListHeight(cmpAlgosSig);
    }, 0);
    refreshCompareSection();
    refreshRunState();

    window.addEventListener('resize', function(){
      if (cmpAlgosKem && cmpAlgosKem.classList.contains('is-active')) setAlgoListHeight(cmpAlgosKem);
      else if (cmpAlgosSig && cmpAlgosSig.classList.contains('is-active')) setAlgoListHeight(cmpAlgosSig);
    });
  })();
</script>
